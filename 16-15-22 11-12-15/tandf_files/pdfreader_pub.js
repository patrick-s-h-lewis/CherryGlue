var CWFileAPI={fsMode:"fsAPI",fs:null,blobUrl:null,dontHideSplash:!1,fallBackObj:{},defferredAction:{obj:null,callback:void 0,reset:function(){this.obj=null;this.callback=void 0;CWPDFReader.processingPub=!1}},checkAvailableFS:function(){return"blobAPI"},updateProgFunc:function(a){a.lengthComputable?CWPDFReader.showLoadProgress(a.loaded/a.total,!0):CWPDFReader.showLoadProgress()},initFileSystem:function(a){CWFileAPI.fallBackObj=a;window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;
window.requestFileSystem(window.TEMPORARY,52428800,function(c){CWFileAPI.fs=c;void 0!=a.blob&&CWFileAPI.writeFileBlob(a)},CWFileAPI.fileSysErrHand)},writeFileBlob:function(a){var c=(new Date).getTime();a.metaData&&a.metaData.identifier&&(c=a.metaData.identifier,c=c.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,""));var b=a.blob,d=a.metaData,e=a.action;CWFileAPI.fs.root.getFile(c,{create:!0},function(a){a.createWriter(function(c){c.onwriteend=function(c){CWUtils.log("Write completed.");c=a.toURL();CWFileAPI.performAction(e,
c,d)};c.onerror=function(a){CWUtils.log("Write failed: "+a.toString())};c.write(b)},CWFileAPI.fileSysErrHand)},CWFileAPI.fileSysErrHand)},fileSysErrHand:function(a){var c="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:c="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:c="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:c="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:c="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:c="INVALID_STATE_ERR";break;default:c=
"Unknown Error"}CWFileAPI.setBlobUrl(CWFileAPI.fallBackObj);CWUtils.log("Error: "+c)},getFileBlob:function(a,c,b,d){function e(a){try{var c=new XMLHttpRequest;c.open("GET",a);c.responseType="blob";c.send();return c}catch(b){window.chrome&&(CWlogger.logConsole("This PDF violates content security policy, please install Chrome extension to view this PDF in colwiz Reader.","Content Security Policy",!0),window.location.hash="",CWPDFReader.hideSplashScr())}}var g=a;CwZ("#cw-loader").find(".cross").off("click").on("click",
function(a){f.abort();CWPDFReader.hideSplashScr()});var h=!1;CWFileAPI.fsMode=CWFileAPI.checkAvailableFS();if(0>a.indexOf("blob")){var f,p=window.location.toString().split("://")[0],k=a.split("://")[0];"https"==p&&"https"!=k?(CWlogger.logConsole("This PDF violates content security policy, please install Chrome extension to view this PDF in colwiz Reader.","Content Security Policy",!0),window.location.hash="",CWPDFReader.hideSplashScr()):f=e(a);"vir"==c?(CWPDFReader.showSplashScr(),f.addEventListener("progress",
CWFileAPI.updateProgFunc,!1),CwZ("#cw-loader").find(".cross").show()):"atl"==c&&f.addEventListener("progress",function(a){a.lengthComputable&&(a=a.loaded/a.total,a=Math.floor(100*a),CWPDFReader.showProgress("pdfDownload","",a,b.index))},!1);f.onabort=function(a){h=!1;setTimeout(CWPDFReader.closeDialog,300);CwZ("#cw-loader").find(".cross").off("click");f.abort()};f.onerror=function(a){a=g;var c=document.createElement("a");c.href=a;a=c.hostname==location.hostname;if(0==f.status&&!a)if(CWUtils.log("CrossDomain"),
window.location.hash="",CWPDFReader.hideSplashScr(),CWPDFReader.openPDFBlobLink=null,CwZ("#cw-pdfFrame").hide(),CwZ("#cw-pdfFrame").remove(),CwZ("#cw-loader").hide(),CwZ("body").css("overflow",""),CWPDFReader.urlToOpen="",CWPDFReader.pageURL="",CWDataCenter.sendOnce=!1,CWPDFReader.pdfFrameRef=null,a=b.index,CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter)CwZ("#bmkcommunication")[0].contentWindow.postMessage(JSON.stringify({message:"crossoriginpdf",params:{index:a}}),"*"),window.chrome&&
CWlogger.logConsole("This PDF violates content security policy, please install Chrome extension to view this PDF in colwiz Reader.","Content Security Policy",!0);else if(b.index){if(a=CwZ(".cw-btnContainer a[data-pub='"+a+"']").parent().eq(0))a=CwZ(a).find(".cw-openPdfReader"),CWPDFReader.selectedPDFIndex=-1,a.removeClass("cw-ldr"),a.addClass("cw-vir"),a.find("span").html(CWPDFReaderConfig.pubModeBtnsTxt.add),a.find("em").html("Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies.");
CWlogger.logConsole("This PDF violates content security policy, please install Chrome extension to view this PDF in colwiz Reader.","Content Security Policy",!0)}};f.onreadystatechange=function(e){if(!h&&CwZ("#cw-loader").is(":visible"))h=!0,CwZ("#cw-loader").find(".cross").show();else if(200==this.status){if(4==this.readyState){var f=this.response;b&&(b.blobType=f.type);if("vir"==c&&0<=f.type.indexOf("text/html"))if(CWFileAPI.dontHideSplash=!0,CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter){window.location.hash=
"";e=b.index;f=CwZ(".cw-btnContainer a[data-pub='"+e+"']");f.removeClass("cw-ldr").addClass("cw-vir");CWPDFReader.selectedPDFIndex=-1;var g=CWPDFReaderConfig.pubModeBtnsTxt.add,k="Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies.";"undefined"!=typeof publisher&&"undefined"!=typeof publisher.pubModeBtnsTxt&&(publisher.pubModeBtnsTxt.view&&(g=publisher.pubModeBtnsTxt.view),publisher.pubModeBtnsTxt.viewHover&&(k=publisher.pubModeBtnsTxt.viewHover));
f.find("span").html(g);f.find("em").html(k);CwZ("#bmkcommunication")[0].contentWindow.postMessage(JSON.stringify({message:"closeaccesspdf",params:{index:e}}),"*");CwZ(".cw-splash-content .cw-content").hide();CwZ(".cw-splash-content .cw-access").show();CwZ(".cw-splash .cw-progress").hide()}else e=CWHtmlStructure.generateReaderHash(d.PDFURL,d.INDEX,!0),history.replaceState({},{},CWPDFReader.pageURL+"#"+e),a=CWPDFReader.UpdateQueryString("redirect",1,a),window.location.replace(a),publisher.readerOptions.showClosedAccessmessage&&
(CwZ(".cw-splash-content .cw-content").hide(),CwZ(".cw-splash-content .cw-access").show(),CwZ(".cw-splash .cw-progress span").text("Please wait, we are redirecting you to login page"));else CWPDFReader.processingPub=!1,CWUtils.log(f),CWPDFReader.fileBlob.blob=f,e={blob:f,action:c,metaData:b},"fsAPI"==CWFileAPI.fsMode?CWFileAPI.initFileSystem(e):"blobAPI"==CWFileAPI.fsMode&&CWFileAPI.setBlobUrl(e)}}else if(200!=this.status&&0!=this.status&&"atl"!=c)CWPDFReader.processingPub=!1,window.location=a;else if(4==
this.readyState&&403==this.status){CWPDFReader.processingPub=!1;if(f=this.response)b.blobType=f.type;e={blob:f,action:c,metaData:b};CWFileAPI.setBlobUrl(e)}else 200!=this.status&&"atl"==c&&4==this.readyState&&(CWUtils.log("302 error in downloading"),CWPDFReader.processingPub=!1,CWPDFReader.fileBlob.blob=f,e={blob:f,action:c,metaData:b},"fsAPI"==CWFileAPI.fsMode?CWFileAPI.initFileSystem(e):"blobAPI"==CWFileAPI.fsMode&&CWFileAPI.setBlobUrl(e))}}else CWPDFReader.processingPub=!1,CWFileAPI.performAction(c,
a,b)},setBlobUrl:function(a){window.URL=window.URL||window.webkitURL;var c=a.action,b=a.metaData;a=a.blob;try{var d=window.URL.createObjectURL(a)}catch(e){}CWFileAPI.performAction(c,d,b)},performAction:function(a,c,b){CWFileAPI.blobUrl=c;CWFileAPI.defferredAction.reset();void 0!=b&&"text/html"!==b.blobType&&(b.blobLink=c,b.data&&(b.data.blobLink=c));if(isMobileDevice())window.location.href=c,CWPDFReader.hideSplashScr();else try{switch(CWPDFReader.urlToOpen=c,a){case "atl":CWDataCenter.setPubSelected(b);
CWDataCenter.setMetaData(b,b.index);CWDataCenter.addToLibrary(b.index);break;case "vir":CWPDFReader.initIFrame()}}catch(d){CWDataCenter.postMsgToSentry(d)}}},CWDataAggregator=function(){function a(){if(0<b){var a=c;c={};b=0;CWDataCenter.postToTracker("events",JSON.stringify(a))}}var c={},b=0;setInterval(a,5E3);return{increment:function(a){c.hasOwnProperty(a)?c[a]++:(c[a]=1,b++)},keys:function(){var a=[],b;for(b in c)c.hasOwnProperty(b)&&a.push(b);return a},forceFlush:function(){a()},clearAll:function(){c=
{};b=0}}}(),CWDataCenter={pub:[],pubSelected:null,sendOnce:!1,eventsHolder:[],exceptionHolder:[],postMsgToSentry:function(a){CWPDFReader.isErrorlogsFrameLoaded?(CWUtils.log("SENTRY ERROR "+a.message),-1!=CWPDFReaderConfig.cwURL.indexOf(CWPDFReaderConfig.sentryDomain)&&a.message&&0<CwZ("#errorlogs").length&&(a.stack+="\n\n ******* -- publisherVersion",CWUtils.log("sending post msg in publisher version"),0<CwZ("#errorlogs").length&&CwZ("#errorlogs")[0].contentWindow.postMessage({message:"sentryException",
data:a.stack},"*"))):(0==CwZ("#errorlogs").length&&CWPDFReader.initSentryFrame(),CWDataCenter.exceptionHolder.push(a))},signoutCall:function(){CWComManager.tell("signoutCallToColwiz",{view:"cwFrame"},"cwFrame")},redirectToMyProfile:function(){CWComManager.tell("redirectToMyProfile",{view:"cwFrame"},"cwFrame")},postToTracker:function(a,c){CWPDFReader.isColwizFrameLoaded?CWComManager.tell("postToTracker",{view:"cwFrame",action:a,metaData:c},"cwFrame"):(CWPDFReader.initColwizFrame(),CWDataCenter.eventsHolder.push(a))},
polling:function(){CWComManager.tell("polling",{view:"cwFrame"},"cwFrame")},setPubSelected:function(a){a&&(CWDataCenter.pubSelected=a,CWComManager.tell("pubSelected",{metaData:a,view:"cwFrame"},"cwFrame"))},loadConfig:function(){CWComManager.tell("loadConfig",{view:"cwFrame"},"cwFrame")},updateUserDOM:function(){CWComManager.tell("updateUserDOM",{view:"cwFrame"},"cwFrame")},getFileId:function(){CWComManager.tell("getFileId",{view:"cwFrame"},"cwFrame")},syncData:function(){var a=CWFileAPI.defferredAction;
a.obj||a.callback||(a.obj="sync",a.callback=function(){CWComManager.tell("syncData",{view:"cwFrame"},"cwFrame");CWFileAPI.defferredAction.reset()});CWComManager.tell("checkLogin",{view:"cwFrame"},"cwFrame")},saveComments:function(a){CWComManager.tell("saveComments",{cmtString:a,view:"cwFrame"},"cwFrame")},createPublication:function(a){void 0==a||0==a.data.length?CWPDFReader.getMetaData(CWDataCenter.pubSelected,CWDataCenter.processTasks):CWComManager.tell("createPublication",{obj:a,view:"cwFrame"},
"cwFrame")},addToLibrary:function(a,c){CWUtils.log(a);a||(a=CWDataCenter.pubSelected.index,CWUtils.log("correctedPublink"),CWUtils.log(a));this.postToTracker("addlib");var b=CWFileAPI.defferredAction;b.obj||b.callback||(b.obj=a,b.callback=function(){CWComManager.tell("addToLibrary",{index:a,view:"cwFrame"},"cwFrame");CWFileAPI.defferredAction.reset()},CWComManager.tell("checkLogin",{showSignIn:c,view:"cwFrame"},"cwFrame"))},downloadPDF:function(a){saveAs(a.blob,a.name+".pdf")},shareFile:function(){},
setPublisherOptions:function(a){CWComManager.tell("setPublisherOptions",{colwizOptions:a,view:"cwFrame"},"cwFrame")},resetVariables:function(){CWComManager.tell("resetVariables",{view:"cwFrame"},"cwFrame")},setLoginShown:function(a){CWComManager.tell("isLoginShown",{isLoginShown:a,view:"cwFrame"},"cwFrame")},setPageMeta:function(a){CWComManager.tell("setPageMeta",{hashMeta:a,view:"cwFrame"},"cwFrame")},setMetaData:function(a,c){CWComManager.tell("setMetaData",{metaData:a,index:c,view:"cwFrame"},"cwFrame")},
processTasks:function(){CWComManager.tell("processTasks",{view:"cwFrame"},"cwFrame")},findFile:function(a){CWComManager.tell("findFile",{bAccess:a,view:"cwFrame"},"cwFrame")},removeAllTasks:function(){CWComManager.tell("removeAllTasks",{view:"cwFrame"},"cwFrame")},checkPendingTasks:function(){CWComManager.tell("checkPendingTasks",{view:"cwFrame"},"cwFrame")},setImporter:function(){CWComManager.tell("setImporter",{view:"cwFrame"},"cwFrame")}},CWComManager={init:function(){window.addEventListener("message",
CWComManager.dom_onMessage,!1)},dom_onMessage:function(a){a=a.data;if("hideLoginFrame"==a)CWComManager.tell("hideLoginPrompt",{view:"pdfFrame"},"pdfFrame"),CwZ("#cw-loginFrame").hide(),CWDataCenter.setLoginShown(!1),CWDataCenter.loadConfig(),null!==CWFileAPI.defferredAction.obj&&void 0!==CWFileAPI.defferredAction.callback&&CWFileAPI.defferredAction.callback(),CWDataCenter.updateUserDOM(),CWFileAPI.defferredAction.reset();else{if("loginFailed"!=a){if("closeLoginFrame"==a){"#nbb"!=location.hash?(CWPDFReader.closeLoginFrame(),
CWDataCenter.setLoginShown(!1)):window.history.back();CWFileAPI.defferredAction.reset();return}if("signupSuccess"==a){CWComManager.tell("hideLoginPrompt",{view:"pdfFrame"},"pdfFrame");CwZ("#cw-loginFrame").hide();CWDataCenter.setLoginShown(!1);CWDataCenter.loadConfig();null!==CWFileAPI.defferredAction.obj&&void 0!==CWFileAPI.defferredAction.callback&&CWFileAPI.defferredAction.callback();CWFileAPI.defferredAction.reset();CWDataCenter.updateUserDOM();return}}!a.message||void 0!=a.data&&"mainExt"!=a.data.view||
CWComManager.processMessage(a)}},tell:function(a,c,b){c=c||{};var d;"cwFrame"==b?(d=CwZ("#cw-colwizFrame")[0],CWPDFReader.isColwizFrameLoaded||CWUtils.log("message lost:"+a)):"pdfFrame"==b?d=CwZ("#cw-pdfFrame")[0]:"cwAuth"==b&&(d=CwZ("#cw-loginFrame")[0]);d&&d.contentWindow.postMessage({message:a,data:c},"*")},processMessage:function(a){if(a.message){switch(a.message){case "adjustHeight":CwZ("#cw-authorFrame").height(a.data.height+"px");break;case "hideAuthTooltip":CWPDFReader.authProfile.hideAuthorTip();
break;case "parseTargetLink":CWParser.parsePDFText(a.data.data.linkIndex,a.data.data.linkRect,a.data.data.divRect,a.data.data.preTargetText,a.data.data.postTargetText,a.data.data.targetText,a.data.data.dest,a.data.data.annotLinkPosX,a.data.data.annotLinkPosY,a.data.data.itemsArr);break;case "cwSentryLoaded":CWPDFReader.isErrorlogsFrameLoaded=!0;for(var c in CWDataCenter.exceptionHolder)CWDataCenter.postMsgToSentry(CWDataCenter.exceptionHolder[c]);CWDataCenter.exceptionHolder=[];break;case "setPublicationId":CWComManager.tell("setPublicationId",
{gotoLibUrl:a.data.pubId,view:"pdfFrame"},"pdfFrame");break;case "webpdfloaded":CWDataCenter.setImporter();CWUtils.log("webpdf success");break;case "addlib":CWDataCenter.postToTracker(a.message);break;case "showLogoutBox":CWPDFReader.showLogoutBox();break;case "postToTracker":CWDataCenter.postToTracker(a.data.message);break;case "dialogEvent":CWDataAggregator.increment(a.data.message);break;case "writeCookie":CWDataCenter.writeCookie(a.data.cookieName,a.data.cookieValue);break;case "closeDialog":CWPDFReader.closeDialog(!0);
break;case "addtolib":CWDataCenter.addToLibrary(void 0,a.data.showSignIn);break;case "downloadPDF":CWDataCenter.downloadPDF(CWPDFReader.fileBlob);break;case "shareFile":CWDataCenter.shareFile();break;case "setBlobUrl":CWFileAPI.setBlobUrl(a.data);break;case "sendException":CWDataCenter.postMsgToSentry(a.data);break;case "redirectToMyProfile":CWDataCenter.redirectToMyProfile();break;case "signoutCall":CWDataCenter.signoutCall();break;case "sync":CWDataCenter.syncData();break;case "initIframe":CWPDFReader.initIFrame();
break;case "commentAdded":CWDataCenter.sendOnce||(CWDataCenter.sendOnce=!0,CWPDFReader.isLogin||CWComManager.tell("showLoginPrompt",{view:"pdfFrame"},"pdfFrame"));break;case "setPdfFrame":CWPDFReader.setPdfFrame(a.data.frameString);break;case "iframe-loaded":if("pdfFrame"==a.data.source){var b=function(){CWPDFReader.loginResponse&&CWPDFReader.isColwizFrameLoaded?(CWDataCenter.setPageMeta(CWPDFReader.hashMeta),CWDataCenter.setPubSelected(g),CWPDFReader.isLogin&&CWDataCenter.getFileId()):setTimeout(function(){b()},
500)};CWPDFReader.isPdfFrameLoaded=!0;CwZ("#cw-pdfFrame").show();if(void 0!=colwizOptions){var d;CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter&&(publisher=d=CwZ("#cw-pdfFrame")[0].contentWindow.publisher);colwizOptions&&document.getElementById("cw-pdfFrame").contentWindow.CWPDFReader.changeReaderLogo()}CWComManager.tell("url",{url:CWPDFReader.urlToOpen,pubSelected:CWPDFReader.records[CWPDFReader.selectedPDFIndex],view:"pdfFrame"},"pdfFrame");try{CWComManager.tell("authArr",{authors:CWPDFReader.authIndexedArr,
view:"pdfFrame"},"pdfFrame")}catch(e){}CWDataCenter.resetVariables();CWDataCenter.setPublisherOptions(CWPDFReader.colwizOptions);d=CWPDFReader.selectedPDFIndex;var g;if(0<=d){CWDataCenter.loadConfig();(g=CWPDFReader.records[d])&&(0<=CWPDFReader.urlToOpen.indexOf("filesystem:")||0<=CWPDFReader.urlToOpen.indexOf("blob:"))&&(g.blobLink=CWPDFReader.urlToOpen);CWDataCenter.setPubSelected(g);var h=(new Date).toLocaleDateString(),f=g.title,f=Base64.decode(f),f=f.substr(0,10);CWPDFReader.fileBlob.name=h+
("_"+f);CWPDFReader.selectedPDFIndex=-1;CWDataCenter.postToTracker("openpdf");d=CwZ(".cw-btnContainer").eq(d);try{0<d.length&&(d.find("span").eq(0).text(CWPDFReaderConfig.pubModeBtnsTxt.view),d.removeClass("cw-ldr").addClass("cw-vir"))}catch(p){}}CWPDFReader.loginResponse?(CWDataCenter.setPageMeta(CWPDFReader.hashMeta),CWDataCenter.setPubSelected(g),CWPDFReader.isLogin&&CWDataCenter.getFileId()):b();CwZ("body").css("overflow","hidden");g&&g.identifier&&CWComManager.tell("logAnalytics",CWPDFReaderConfig.cwURL+
"/openReader?pubId="+CWPDFReader.colwizOptions.appId+"&ident="+g.identifier,"cwAuth")}else if("cwFrame"==a.data.source){CWPDFReader.isColwizFrameLoaded=!0;if(publisher.readerOptions.authorProfile){h=[];for(f=0;f<CWPDFReader.records.length;f++)h[f]=CWPDFReader.records[f].identifier;h=JSON.stringify(h);CWComManager.tell("getAuthors",{view:"cwFrame",path:CWPDFReaderConfig.cwURL+"/auapi?appId="+publisher.appId+"&q=doi",data:{data:h},isPubPage:CWParser.isPubPage()},"cwFrame")}CWDataCenter.loadConfig();
CWDataCenter.setPublisherOptions(CWPDFReader.colwizOptions);if(0<CWDataCenter.eventsHolder.length){for(d in CWDataCenter.eventsHolder)CWComManager.tell("postToTracker",{view:"cwFrame",action:CWDataCenter.eventsHolder[d],metaData:CWDataCenter.pubSelected},"cwFrame");CWDataCenter.eventsHolder=[]}}CWDataCenter.updateUserDOM();0==CWPDFReader.buttonsInjected&&(CWPDFReader.buttonsInjected=!0);CWPDFReader.isColwizFrameLoaded&&CWPDFReader.isPdfFrameLoaded&&CWDataCenter.pubSelected&&CWPDFReader.extractReferenceFromPage(CWDataCenter.pubSelected);
break;case "saveComments":CWUtils.log("Save Comments String:"+a.data.cmtString);CWDataCenter.saveComments(a.data.cmtString);break;case "loadComments":CWPDFReader.pdfFrameRef&&CWPDFReader.pdfFrameRef.CWCommentManager.loadComments(a.data.commentStr);break;case "getComments":CWPDFReader.pdfFrameRef&&CWDataCenter.saveComments(CWPDFReader.pdfFrameRef.CWCommentManager.getCommentsString());break;case "getData":if(CWParser){var k=a.data.metadata;CWParser.getData({metadata:k,success:function(a,c){k.data=a;
k.type=c;CWDataCenter.setMetaData(k,k.index)}})}break;case "defferredAction":d=CWFileAPI.defferredAction;CWPDFReader.checkLoginInProgress=!1;a.data.loggedIn?void 0!=d.obj&&d.callback&&d.callback():"checkForDownloadPopup"==d.obj||"checkForAddLibPopup"==d.obj?void 0!=d.obj&&d.callback&&d.callback():(a.data.showSignIn&&CwZ("#cw-loginFrame")[0].contentWindow.postMessage({message:"sendShowLogin",param:{}},"*"),CwZ("#cw-loginFrame").show(),CWDataCenter.setLoginShown(!0));break;case "showLoginFrame":CwZ("#cw-loginFrame").show();
CWDataCenter.setLoginShown(!0);break;case "sendJSONToReader":CWComManager.tell("sendJSONToReader",{jsonData:a.data.jsonData,view:"pdfFrame"},"pdfFrame");break;case "sendShowLogin":CwZ("#cw-loginFrame")[0].contentWindow.postMessage({message:"sendShowLogin",param:{}},"*");CwZ("#cw-loginFrame").show();CWDataCenter.setLoginShown(!0);break;case "hideSplashScr":CWPDFReader.hideSplashScr();break;case "showProgress":CWPDFReader.showProgress(a.data.type,a.data.message,a.data.progress,a.data.index);break;case "hideProgress":CWPDFReader.hideProgress(a.data.timeout,
a.data.index);break;case "hasPubInLib":CWPDFReader.hasPubInLib(a.data.bValue,a.data.index);break;case "updateUser":null!=CWPDFReader.pdfFrameRef&&void 0!=CWPDFReader.pdfFrameRef.CWPDFReader&&CWPDFReader.pdfFrameRef.CWPDFReader.updateUser(a.data);break;case "uploadFile":void 0!=CWPDFReader.urlToOpen&&(0<=CWPDFReader.urlToOpen.indexOf("filesystem:")||0<=CWPDFReader.urlToOpen.indexOf("blob:"))&&(a.data.blobLink=CWPDFReader.urlToOpen);CWPDFReader.uploadFile(a.data.pdfLink,a.data.index,a.data.params,a.data.blobLink);
break;case "postFile":CWPDFReader.postFile(a.data.obj,a.data.url);break;case "getMetaData":CWPDFReader.getMetaData(a.data.metaData,CWDataCenter.setMetaData);break;case "showSyncMode":null!=CWPDFReader.pdfFrameRef&&CWPDFReader.pdfFrameRef.CWPDFReader.showSyncMode();break;case "showAddMode":null!=CWPDFReader.pdfFrameRef&&CWPDFReader.pdfFrameRef.CWPDFReader.showAddMode();break;case "logoutCallback":CWComManager.tell("logoutCallback",{view:"pdfFrame"},"pdfFrame");window.location.reload();break;case "unsyncedChanges":CWPDFReader.unsyncedChanges=
!0;break;case "syncedChanges":CWPDFReader.unsyncedChanges=!1;CwZ(window).off("beforeunload");break;case "set_bLogin":CWPDFReader.set_bLogin(a.data.bLogin);break;case "logConsole":CWPDFReader.logConsole(a.data.strText,a.data.strHeading,a.data.bPromptUser);break;case "hideSyncingDisplay":CWPDFReader.hideSyncingDisplay();break;case "checkForPDFAccess":CWPDFReader.checkForPDFAccess(a.data.pdfLink);break;case "setPendingTasks":CWPDFReader.setPendingTasks(a.data.value);break;case "checkDropdownLogin":0==
CWPDFReader.checkLoginInProgress&&(d=CWFileAPI.defferredAction,d.obj="checkForAddLibPopup",d.callback=function(){CWComManager.tell("checkLoginResponse",{isLogin:CWPDFReader.isLogin,view:"pdfFrame"},"pdfFrame");CWFileAPI.defferredAction.reset()},CWPDFReader.checkLoginInProgress=!0,CWComManager.tell("checkLogin",{view:"cwFrame"},"cwFrame"));break;case "checkDownloadLogin":0==CWPDFReader.checkLoginInProgress&&(d=CWFileAPI.defferredAction,d.obj="checkForDownloadPopup",d.callback=function(){CWComManager.tell("checkDownloadResponse",
{isLogin:CWPDFReader.isLogin,view:"pdfFrame"},"pdfFrame");CWFileAPI.defferredAction.reset()},CWPDFReader.checkLoginInProgress=!0,CWComManager.tell("checkLogin",{view:"cwFrame"},"cwFrame"));break;case "getRelatedPubs":CWComManager.tell("getRelatedPubs",{view:"cwFrame",data:a.data.message.url},"cwFrame");break;case "setRelatedPubs":CWComManager.tell("setRelatedPubs",{data:a.data,view:"pdfFrame"},"pdfFrame");break;case "addRelatedPub":d=CWFileAPI.defferredAction;d.obj={};d.callback=function(){CWComManager.tell("addRelatedPub",
{view:"cwFrame",eId:a.data.eId},"cwFrame");CWFileAPI.defferredAction.reset()};CWComManager.tell("checkLogin",{view:"cwFrame"},"cwFrame");break;case "addRelatedPubResp":CWComManager.tell("addRelatedPubResp",{data:a.data.value,view:"pdfFrame"},"pdfFrame");break;case "executeFormattedCitation":CWPDFReader.executeFormatCitation(a.data.style);break;case "cslResponse":var l=a.data.response,m=[];Utility.getData({metadata:CWDataCenter.pubSelected,success:function(a,c){var b="";"ris"==CWDataCenter.pubSelected.type?
(b=RisParser(a,CWDataCenter.pubSelected),CWCSL.testPublication=b):b=BibtexParser(a);m.push(b.entries[0]);b=CWCSL.getCitationHTML(m,l);CWComManager.tell("citationHTML",{citationHTML:b.bibliography,view:"pdfFrame"},"pdfFrame")}});break;case "cslJSONResponse":CWComManager.tell("cslJsonResponse",{cslJson:a.data.response,view:"pdfFrame"},"pdfFrame");break;case "serverRefsResponse":a.data.resp.citations&&0<a.data.resp.citations.length?CWPDFReader.processReferencesFromServer(a.data.resp.citations,a.data.metadata):
CWPDFReader.extractReferenceFromPage(a.data.metadata);break;case "noRefsFoundOnServer":CWPDFReader.extractReferenceFromPage(a.data.metadata);break;case "ajaxCall":CWComManager.tell("ajaxCall",{view:"cwFrame",data:a.data.data},"cwFrame");break;case "sendAuthors":try{if(CWParser.isPubPage()){CWPDFReader.authArr[0]={};CWPDFReader.authArr[0].authors=a.data.resp;for(h=0;h<a.data.resp.length;h++){var n=a.data.resp[h];CWPDFReader.authIndexedArr[n.id]=n}CWParser.insertAuthorsLeftPanel();CWPDFReader.appendAuthorsToLeftPanel(CWPDFReader.authArr)}else for(h=
0;h<a.data.resp.length;h++)for(CWPDFReader.authArr[h]=a.data.resp[h],d=0;d<CWPDFReader.authArr[h].authors.length;d++)f=CWPDFReader.authArr[h].authors[d],CWPDFReader.authIndexedArr[f.id]=f;CWPDFReader.authProfile=new CWAuthorApi(CWPDFReader.authIndexedArr,CwZ("body")[0]);CWParser.insertClassInAuthorsLink(CWPDFReader.authArr);CWPDFReader.authProfile.registerAuthBtnEvents()}catch(q){CWUtils.log("no authors data found")}break;case "ajaxCallResp":CWComManager.tell("ajaxCallResp",{data:a.data.data,view:"pdfFrame"},
"pdfFrame")}CWUtils.log("pdfreader_pub.js processMessage:"+a.message)}}},CWPDFReader={urlToOpen:"",pageURL:"",pdfFrameRef:null,colwizOptions:null,bPDFFrameLoaded:!1,records:[],hashMeta:{},fileBlob:{blob:null,name:null},btnHash:null,frameHTML:"",isLogin:!1,oldPageHash:"",processingPub:!1,unsyncedChanges:!1,authArr:[],isAuthorProfActive:!1,authIndexedArr:{},bPdfFrameLoaded:!1,buttonsInjected:!1,isColwizFrameLoaded:!1,isErrorlogsFrameLoaded:!1,isPdfFrameLoaded:!1,currentPubReferences:null,selectedPDFIndex:-1,
loginResponse:!1,checkLoginInProgress:!1,bGetCSLDone:!1,authProfile:{},authorWidgetWidth:580,frameTipHorizontalPosition:"left",authorWidgetAverageHeight:600,authorWidgetHeight:"",init:function(){CWUtils.log("LOADING PARSER Pub: "+CWPDFReaderConfig.parser);try{CWParser.parsePage?(clearTimeout(CWPDFReader.initilizeTimeout),CWComManager.init(),CWPDFReader.colwizOptions=window.colwizOptions,CWParser.parsePage({success:function(a){CWUtils.log("linkCount:"+a);var b=CWHtmlStructure.getSignupDialog();CwZ("body").append(b);
if(0<CwZ(".cw-addToLib").length)CwZ(".cw-addToLib").off("click").on("click",CWPDFReader.addToLibrary);if(0<CwZ(".cw-openPdfReader").length)CwZ(".cw-openPdfReader").off("click").on("click",function(){var a=CwZ(this);CWUtils.log(a);a=a.closest(".cw-btnContainer").data("metadata");void 0!=a.blobLink&&(CWPDFReader.openPDFBlobLink=a.blobLink);CWPDFReader.openDialog();CWPDFReader.onHashChange()});if(0<CwZ(".showDownloadPopup").length)CwZ(".showDownloadPopup").off("click").on("click",function(a){function c(){function a(){CwZ("#downloadPopupOverlay").remove();
e.each(function(a){"downloadPopupOverlay"!=CwZ(e[a]).attr("id")&&CwZ(e[a]).attr("aria-hidden","false")});CwZ(f).focus()}0!=CwZ("#downloadPopupOverlay").length&&CwZ("#downloadPopupOverlay").remove();b.pubLink=b.pubLink.replace("abs/","full/");var d=CWHtmlStructure.getDownloadPopup(b,publisher);CwZ("body").append(d);var e=CwZ("body").children();e.each(function(a){"downloadPopupOverlay"!=CwZ(e[a]).attr("id")&&CwZ(e[a]).attr("aria-hidden","true")});var f=CwZ(":focus"),d=CwZ("#downloadPopupOverlay");d.attr("aria-hidden",
"false");d.find("*").filter("a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]").filter(":visible").first().focus();CwZ("#closeDownloadPopup,#downloadPopupBody a").off("click").on("click",function(c){if("downloadPdf"===CwZ(this).attr("id")){if(CWDataCenter.postToTracker("downloadPopup",b),CwZ("#downloadPopupOverlay").hide(),CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher)try{ga("send",
"event","button","colwiz \u2013 Download PDF")}catch(d){}}else if("viewIPDF"===CwZ(this).attr("id")){c.preventDefault();if(CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher)try{ga("send","event","button","colwiz \u2013 Interactive PDF")}catch(e){}CWDataCenter.postToTracker("viewIPDFPopup",b);c=b.pubLink+"#"+btoa(b.pdfLink+"@@@0");CwZ("#downloadPopupOverlay").hide();publisher.readerOptions.readerSamePage?window.location.hash=btoa(b.pdfLink+"@@@"+b.index):window.open(c,"_blank")}else"SavePDF"===
CwZ(this).attr("id")?CWDataCenter.addToLibrary(b.index):CwZ("#downloadPopupOverlay").hide();a()});CwZ("#downloadPopupOverlay").on("click",function(c){"cw-dialog-overlay"==c.target.classList&&a()});CwZ("#resetTabInd").on("focus",function(){CwZ("#closeDownloadPopup").focus()});CwZ("body").off("keydown").on("keydown",function(c){27==c.keyCode&&a()})}a.preventDefault();var b=CwZ(this).data("metadata"),d=b.pubLink+"#"+btoa(b.pdfLink+"@@@0");switch(a.which){case 1:a.ctrlKey?window.open(d):(CWDataCenter.postToTracker("optionPopup",
b),c());break;case 2:window.open(d)}});var d={};0<a.length&&(CWPDFReader.records=a,CwZ(a).each(function(b){var g=a[b];g.index=b;d[b]||(g.title=Base64.encode(g.title));d[b]=g}),CWPDFReader.hashMeta=d);CWPDFReader.onHashChange()},addButton:CWHtmlStructure.insertButtonsOnPage}),CWDataCenter.loadConfig(),CWPDFReader.checkBrowser(),setTimeout(function(){try{CwZ("#bmkcommunication")[0].contentWindow.postMessage(JSON.stringify({message:"webpdfloaded",param:{}}),"*")}catch(a){}},2E3)):CWPDFReader.initilizeTimeout=
setTimeout(CWPDFReader.init,100)}catch(a){CWUtils.log(a),CWDataCenter.postMsgToSentry({view:"mainExt",message:a.message,stack:a.stack})}},executeFormatCitation:function(a){CWPDFReader.formatCitation(a);CWPDFReader.bGetCSLDone||(CWPDFReader.bGetCSLDone=!0,CWPDFReader.getCSLJson())},appendAuthorsToLeftPanel:function(a){var c="";a=a[0].authors;for(var b=0;b<a.length;b++)var d=a[b],e=d.coAuthors?d.coAuthors:0,g=d.pubs?d.pubs:0,h=this.getInitials(d.fullName),f=this.getAvatarColor(h),c=c+CWHtmlStructure.getAuthorSidebarWidget(h,
f,d,g,e);CwZ(".cw-authProfileList").append(c);CwZ(".cw-panel").show()},getInitials:function(a){a=a.toUpperCase().split(/[\s.]+/);var c="";return c=1==a.length?a[0].charAt(0):a[0].charAt(0)+a[a.length-1].charAt(0)},getAvatarColor:function(a){try{var c="#626be0 #e06277 #b467da #e09862 #1abc9c #f44336 #3498db #673ab7 #34495e #8bc24a #27ae60 #2980b9 #8e44ad #6c3244 #f1c40f #2266e6 #e74c3c #49D4B4 #4498ae #f39c12 #2c5e1c #ea1e63 #62b6e0 #484d9c".split(" "),b=" A B C D E F G H I J K L M N O P Q R S T U V W X Y Z".split(" "),
d=b.slice();d.shift();var e="";b.forEach(function(b,f){d.forEach(function(d,f){a==b+d&&(e=c[f%c.length])})});return e}catch(g){return"#000000"}},registerAuthBtnEvents:function(){var a;CwZ(document).mouseup(function(a){var b=CwZ("#cw-authorFrame");b.is(a.target)||0!==b.has(a.target).length||CwZ("#cw-authorFrame").fadeOut()});CwZ("#cw-authorFrame").hover(function(a){CWPDFReader.isAuthorProfActive=!0},function(a){CWPDFReader.isAuthorProfActive=!1;CwZ("#cw-authorFrame").fadeOut()});CwZ(".cw-authorLink").hover(function(c){a=
setTimeout(function(){c.preventDefault();CWPDFReader.authProfile.showAuthorTip(c,!0)},1200)},function(c){clearTimeout(a);setTimeout(function(){!1===CWPDFReader.isAuthorProfActive&&CWPDFReader.authProfile.hideAuthorTip()},1E3)})},setPositionOfFrame:function(a){a=CwZ(a.target).closest(".cw-authorLink");var c=CwZ(document).width(),b=CwZ(a).offset(),c=c-b.left;a=CwZ(a).width();c>CWPDFReader.authorWidgetWidth?(a=parseInt(b.left)+a+20,c="auto",CWPDFReader.frameTipHorizontalPosition="left"):(a="auto",c=
parseInt(c)+20,CWPDFReader.frameTipHorizontalPosition="right");var d=CwZ(window.top).height(),e=b.top-CwZ(document).scrollTop(),d=d-e,b=parseInt(d)>CWPDFReader.authorWidgetAverageHeight?parseInt(b.top)-50:parseInt(d)<CWPDFReader.authorWidgetAverageHeight&&parseInt(e)<CWPDFReader.authorWidgetAverageHeight?parseInt(b.top)-CWPDFReader.authorWidgetAverageHeight/2:parseInt(b.top)-CWPDFReader.authorWidgetHeight+50;CwZ("#cw-authorFrame").css("left",a).css("right",c).css("top",b)},formatCitation:function(a){var c=
"",c=a?CWPDFReaderConfig.cwURL+"/cwdata/csl/"+a+".csl":CWPDFReaderConfig.cwURL+"/cwdata/csl/apa.csl";CWComManager.tell("getCSLFile",{view:"cwFrame",path:c},"cwFrame")},getCSLJson:function(){CWComManager.tell("getCSLJson",{url:CWPDFReaderConfig.cwURL+"/cwdata/csl/js/csl.json"},"cwFrame")},UpdateQueryString:function(a,c,b){b||(b=window.location.href);var d=new RegExp("([?&])"+a+"=.*?(&|#|$)(.*)","gi"),e;if(d.test(b)){if("undefined"!==typeof c&&null!==c)return b.replace(d,"$1"+a+"="+c+"$2$3");e=b.split("#");
b=e[0].replace(d,"$1$3").replace(/(&|\?)$/,"");"undefined"!==typeof e[1]&&null!==e[1]&&(b+="#"+e[1]);return b}"undefined"!==typeof c&&null!==c&&(d=-1!==b.indexOf("?")?"&":"?",e=b.split("#"),b=e[0]+d+a+"="+c,"undefined"!==typeof e[1]&&null!==e[1]&&(b+="#"+e[1]));return b},initSentryFrame:function(){var a='<iframe id="errorlogs" style="display: none; position: fixed; top: 0px; left:0px; z-index:9001; border: 0px;" width="100%" height="100%" src="https://'+CWPDFReaderConfig.sentryDomain+'/errorlogs?type=1"></iframe>';
CwZ("body").append(a)},initIFrame:function(){if(0<CwZ("#cw-pdfFrame").length)return!0;0>=CwZ("#cw-pdfFrame").length&&CwZ("body").append("<iframe allowfullscreen webkitallowfullscreen mozallowfullscreen id='cw-pdfFrame' style='display: none; position: fixed; top: 0px; left:0px; z-index:9000; border: 0px; background-color: rgba(0, 0, 0, 0.5)' width='100%' height='100%' onload='CWPDFReader.onLoadIframe()' data-version='1.001'></iframe>");return!1},onLoadIframe:function(){try{if(!CWPDFReader.bPDFFrameLoaded){0<=
CWPDFReader.urlToOpen.indexOf("filesystem:")||0<=CWPDFReader.urlToOpen.indexOf("blob:")?CWPDFReader.updateIFrame(CWPDFReader.urlToOpen):CWFileAPI.getFileBlob(CWPDFReader.urlToOpen,"vir");CWPDFReader.bPDFFrameLoaded=!0;try{CwZ("html").css("overflow","hidden")}catch(a){}}}catch(c){CWDataCenter.postMsgToSentry({view:"mainExt",message:c.message,stack:c.stack})}},closeDialog:function(a){if(1==CWPDFReader.unsyncedChanges)1==confirm("You have unsaved changes. If you leave the page these changes will be lost.")?
(CWPDFReader.unsyncedChanges=!1,CwZ("html").css("overflow",""),CWPDFReader.close(a),CWDataAggregator.forceFlush()):location.hash=CWPDFReader.oldPageHash;else{CWPDFReader.unsyncedChanges=!1;try{CwZ("html").css("overflow","")}catch(c){}CWPDFReader.close();CWDataAggregator.forceFlush()}},initSplashScr:function(){var a="";CwZ(".cw-btnContainer").eq(1).hasClass("ascelibrary-detail")&&(a="asceOverlay");a=CWHtmlStructure.getSplashScreen(a);CwZ("body").append(a);CwZ.fn.center=function(){this.css("position",
"fixed");this.css("top","0px");this.css("left","0px");return this}},showSplashScr:function(){CwZ("#cw-loader").center();setTimeout(function(){CwZ("#cw-loader").show();CwZ("#cw-loader").center()},200);CwZ("#cw-loader").find(".cross").hide();CWUtils.log("shown cw-loader")},hideSplashScr:function(){CwZ(".cw-splash-content .cw-content").show();CwZ(".cw-splash-content .cw-access").hide();CwZ(".cw-splash .cw-progress span").text("Loading article...");CwZ(".cw-splash .cw-progress").show();CwZ("#cw-loader").remove()},
showLoadProgress:function(a){CwZ("#cw-loader .cw-progress").addClass("cw-indefinite");isNaN(a)?CwZ("#cw-loader .cw-bar").width("100%"):CwZ("#cw-loader .cw-bar").width(Math.floor(100*a)+"%")},updateIFrame:function(a){var c=CWHtmlStructure.getHead(CWPDFReaderConfig.staticDomainURL+"/js/webpdf",CWPDFReaderConfig.staticDomainURL+"/css/webpdf",cPDF?cPDF.version:"15.12.22-270-40"),b=CWHtmlStructure.getBody(CWPDFReaderConfig.cwURL+"/images/webpdf/",a),b=b.replace(/reqFilesURL/g,CWPDFReaderConfig.staticDomainURL),b=b.replace('<input id="cw-pdfURL" type="hidden" value="pdfUrl"/>',
'<input id="cw-pdfURL" type="hidden" value="'+a+'"/>'),c="<html><head>"+c+"</head><body class='cw-prefix'>"+b+"</body></html>";CWUtils.log("IFRAME UPDATED");CWPDFReader.pdfFrameRef=CwZ("#cw-pdfFrame").get(0).contentWindow;b=CWPDFReader.pdfFrameRef.document.open("text/html","replace");b.write(c);b.close();CwZ("#cw-pdfURL").attr("value",a)},setPdfFrame:function(a){CWPDFReader.frameHTML=a},initLoginFrame:function(){var a='<iframe id="cw-loginFrame" style="display: none; position: fixed; top: 0px; left:0px; z-index:9001; border: 0px;" width="100%" height="100%" src="'+
(CWPDFReaderConfig.cwURL+"/cwauth?appid="+("undefined"!==typeof publisher&&publisher.appId?publisher.appId:location.hostname)+"&public=1")+'"></iframe>';CwZ("body").append(a)},initColwizFrame:function(){var a="",a=CWPDFReaderConfig.cwURL+"/js/webpdf/pages/ireader.html?v="+cPDF.version;0>=CwZ("#cw-colwizFrame").length&&(a="<iframe allowfullscreen webkitallowfullscreen mozallowfullscreen id='cw-colwizFrame' style='display: none; position: fixed; top: 0px; left:0px; z-index:0; border: 0px;' width='0%' height='0%' onload='CWPDFReader.onLoadColwizIframe()' src='"+
a+"' data-version='"+cPDF.version+"'></iframe>",CwZ("body").append(a))},onLoadColwizIframe:function(){CWDataCenter.setPublisherOptions(CWPDFReader.colwizOptions);CWDataCenter.setPubSelected(CWDataCenter.pubSelected);for(var a in CWPDFReader.hashMeta)break},showLogoutBox:function(){CWComManager.tell("showLogoutBox",{view:"pdfFrame"},"pdfFrame")},showServerDown:function(){CWComManager.tell("showLogoutBox",{view:"pdfFrame"},"pdfFrame")},hideSyncingDisplay:function(){CWComManager.tell("hideSyncingDisplay",
{view:"pdfFrame"},"pdfFrame")},postFile:function(a,c){var b=CWFileUpload.fileData,d=CwZ("#cw-fileUpload").data("blueimpFileupload");d.options.formData=a;d.options.url=c;b.submit()},openDialog:function(a){if(!(void 0!=a&&a.originalEvent instanceof MouseEvent)){var c=null,b="";CWUtils.log(a);if(void 0!=a)if(c=CwZ(".cw-openPdfReader[data-pub="+a.INDEX+"]"),null!=CWPDFReader.openPDFBlobLink?(CWUtils.log("opening the pdf from blob that's already in browser's memory"),b=CWPDFReader.openPDFBlobLink):b=a.PDFURL,
a.FORWARDED)b=CWHtmlStructure.generateReaderHash(a.PDFURL,a.INDEX),history.replaceState({},{},CWPDFReader.pageURL+"#"+b),history.back();else if(c&&b){CWPDFReader.initSplashScr();CWPDFReader.btnHash=a;var d=parseInt(a.INDEX);CWFileAPI.getFileBlob(b,"vir",CWPDFReader.records[d],a);CWUtils.log("initializing colwiz and login iframes");CWPDFReader.initColwizFrame();CWPDFReader.initLoginFrame();CWDataCenter.setPubSelected(CWPDFReader.records[d]);CWDataCenter.postToTracker("clickpdf",CWPDFReader.records[d]);
CWPDFReader.selectedPDFIndex=d;CWPDFReader.records.length-1>=d?CWPDFReader.records[d].pdfLink!==a.PDFURL&&(d=a.PDFURL.replace("/pdf/","/abs/")+"#"+btoa(a.PDFURL+"@@@0"),window.location.replace(d)):(d=a.PDFURL.replace("/pdf/","/abs/")+"#"+btoa(a.PDFURL+"@@@0"),window.location.replace(d));CWPDFReaderConfig.readerMode===CWPDFReaderMode.Webimporter&&CWDataCenter.setPubSelected(CWPDFReader.records[a.INDEX]);c.removeClass("cw-vir").addClass("cw-ldr");c.find("span").text("Loading IPDF Reader");a=c.closest(".cw-btnContainer").data("metadata");
CWPDFReader.urlToOpen=void 0!=a&&void 0!=a.blobLink?a.blobLink:b}}},onHashChange:function(){if(location.hash!=CWPDFReader.PDFHash){var a=location.href,c=location.hash;CWPDFReader.PDFHash=location.hash;CWUtils.log("HASH CHANGE: "+c);var b=-1<Base64.decode(c).indexOf("@@@");if("#nbb"==location.hash&&"hidden"==CwZ("body").css("overflow"))window.history.back(),window.history.back();else if("#nbb"!=location.hash)if(b){for(var b=c.split("#"),d=0;d<b.length;d++)try{if(-1<Base64.decode(b[d]).indexOf("@@@")){c=
b[d];break}else c=""}catch(e){CWUtils.log(e)}c=c.replace("#","");0<c.length?(CWPDFReader.oldPageHash=window.location.hash,CWPDFReader.pageURL=a.replace("#"+c,""),a=CWHtmlStructure.decodeReaderHash(c),void 0!=a&&void 0!=a.PDFURL&&a.PDFURL!=CWPDFReader.urlToOpen&&CWPDFReader.openDialog(a)):1==CWPDFReader.unsyncedChanges?1==confirm("You have unsaved changes. If you leave the page these changes will be lost.")?(CWPDFReader.unsyncedChanges=!1,CWPDFReader.close(),CWPDFReader.closeLoginFrame()):location.hash=
CWPDFReader.oldPageHash:(CWPDFReader.close(),CWPDFReader.closeLoginFrame())}else setTimeout(function(){CWPDFReader.closeDialog()},1E3)}},close:function(a){CWPDFReader.PDFHash="";CWPDFReader.bPDFFrameLoaded=!1;PDFHash="";CWPDFReader.openPDFBlobLink=null;CwZ("#cw-pdfFrame").hide();CwZ("#cw-pdfFrame").remove();CWFileAPI.dontHideSplash||(CwZ("#cw-loader").hide(),CwZ(".cw-splash-content .cw-content").show(),CwZ(".cw-splash-content .cw-access").hide(),CwZ(".cw-splash .cw-progress span").text("Loading article..."),
CwZ(".cw-splash .cw-progress").show());CwZ("body").css("overflow","");CWPDFReader.urlToOpen="";CWPDFReader.pageURL="";CWDataCenter.sendOnce=!1;CWPDFReader.pdfFrameRef=null;history.replaceState({},{},location.protocol+"//"+location.host+location.pathname+(location.search?location.search:""));var c=CwZ(".cw-openPdfReader.cw-ldr");0<c.length&&(c.removeClass("cw-ldr").addClass("cw-vir"),c.find("span").text(CWPDFReaderConfig.pubModeBtnsTxt.view));a&&(location.hash="");CWComManager.tell("findPubsCall",
{view:"cwFrame"},"cwFrame")},addToLibrary:function(a,c){try{c=CwZ(this);var b=c.closest(".cw-btnContainer").data("metadata");c.hasClass("cw-vil")?window.open(CWPDFReaderConfig.cwURL+"/app?x=1c","_blank"):(CWPDFReader.processingPub?CWPDFReader.showProgress("queue","Queued to add","",b.index):(CWPDFReader.processingPub=!0,void 0!=b.pdfLink&&0<b.pdfLink.length?CWPDFReader.showProgress("wait","Processing PDF","",b.index):CWPDFReader.showProgress("wait","Processing...","",b.index)),void 0!=b&&(CWFileAPI.defferredAction.obj=
b,CWFileAPI.defferredAction.callback=b.blobLink?function(){CWFileAPI.getFileBlob(b.blobLink,"atl",b);CWFileAPI.defferredAction.reset()}:function(){CWFileAPI.getFileBlob(b.pdfLink,"atl",b);CWFileAPI.defferredAction.reset()},CWComManager.tell("checkLogin",{view:"cwFrame"},"cwFrame")))}catch(d){CWDataCenter.postMsgToSentry({view:"mainExt",message:d.message,stack:d.stack})}},setPendingTasks:function(a){if(a)CwZ(window).on("beforeunload",function(){return"You have unsaved changes. If you leave the page these changes will be lost."});
else CwZ(window).off("beforeunload")},showLoginFrame:function(){CwZ("#cw-loginFrame").show()},closeLoginFrame:function(){CwZ("#cw-loginFrame").hide();var a=CwZ(".cw-qta");0<a.length&&(a.removeClass("cw-qta").addClass("cw-atl"),a.find("span").html(CWPDFReaderConfig.pubModeBtnsTxt.add),a.find("em").html("Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies."));a=CwZ(".cw-ail");0<a.length&&(a.removeClass("cw-ail").addClass("cw-atl"),a.find("span").html(CWPDFReaderConfig.pubModeBtnsTxt.add),
a.find("em").html("Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies."));CWComManager.tell("hideWaitingMsg",{view:"pdfFrame"},"pdfFrame");CWDataCenter.removeAllTasks();CWDataCenter.checkPendingTasks()},showProgress:function(a,c,b,d){if(CWPDFReader.isLogin||"wait"==a)if(CWPDFReader.pdfFrameRef)CWPDFReader.pdfFrameRef.CWPDFReader.showProgress(a,c,b);else if(void 0!=d&&(c=CwZ(".cw-btnContainer a[data-pub='"+d+"']").parent().eq(0))){var e=CwZ(c).find(".cw-addToLib");
if("queue"==a)e.removeClass("cw-atl"),e.addClass("cw-qta"),e.find("span").html("Queued to Add"),e.find("b").width("0%"),e.find("em").html("Adding Reference to colwiz Library");else if("pdfDownload"==a)e.find("b").width(b+"%");else if("bInLibrary"==a)e.find("b").width("100%"),setTimeout(function(){e.removeClass("cw-atl");e.removeClass("cw-ail");e.removeClass("cw-qta");e.addClass("cw-vil");var a="View in colwiz Library",c="This article is already in your Library. Click to view in colwiz.";"undefined"!=
typeof publisher&&"undefined"!=typeof publisher.pubModeBtnsTxt&&(publisher.pubModeBtnsTxt.inMyLib&&(a=publisher.pubModeBtnsTxt.inMyLib),publisher.pubModeBtnsTxt.inMyLibHover&&(c=publisher.pubModeBtnsTxt.inMyLibHover));e.find("span").html(a);e.find("em").html(c)},600);else if("addPub"==a)e.removeClass("cw-atl"),e.removeClass("cw-qta"),e.addClass("cw-ail"),e.find("span").html("Adding Metadata"),e.find("b").width(b+"%"),e.find("em").html("Adding Reference to colwiz Library");else if("progress"==a)e.removeClass("cw-atl"),
e.removeClass("cw-qta"),e.addClass("cw-ail"),e.find("span").html("Adding PDF"),50>=b&&e.find("b").width(parseInt(b+50)+"%"),e.find("em").html("Uploading PDF to colwiz Library");else if("wait"==a)e.removeClass("cw-atl"),e.removeClass("cw-qta"),e.addClass("cw-ail"),e.find("span").html("Processing PDF"),e.find("em").html("Please wait");else if("userLoggedOut"==a||"failure"==a)e.removeClass("cw-vil"),e.removeClass("cw-ail"),e.removeClass("cw-qta"),e.addClass("cw-atl"),e.find("span").html(CWPDFReaderConfig.pubModeBtnsTxt.add),
e.find("em").html("Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies.")}},hideProgress:function(a,c){try{if(CWPDFReader.pdfFrameRef)CWPDFReader.pdfFrameRef.CWPDFReader.hideProgress(a);else if(void 0!=c){var b=CwZ(".cw-btnContainer:eq("+c+") .cw-addToLib");b&&(void 0==a&&(a=0),setTimeout(function(){CwZ(b).find(".cw-process-btn, .cw-progress, .cw-sync").hide();CwZ(b).find(".cw-progress i").width("0%")},a))}}catch(d){CWDataCenter.postMsgToSentry(d)}},
hasPubInLib:function(a,c){null!=CWPDFReader.pdfFrameRef&&void 0!=CWPDFReader.pdfFrameRef.CWPDFReader?CWDataCenter.pubSelected.index==c&&CWPDFReader.pdfFrameRef.CWPDFReader.hasPubInLib(a):a&&CWPDFReader.showProgress("bInLibrary","View in colwiz Library",0,c)},uploadFile:function(a,c,b,d){try{null!=b.euId&&(CWFileUpload.euId=b.euId),null!=b.fileId&&(CWFileUpload.fileId=b.fileId),CWFileUpload.upload(a,c,d)}catch(e){CWDataCenter.postMsgToSentry({view:"mainExt",message:e.message,stack:e.stack})}},getUploadParams:function(a){CWComManager.tell("getUploadParams",
a,"cwFrame")},uploadSync:function(a){CWPDFReader.pdfFrameRef&&(a.doSync=!0);CWComManager.tell("uploadSync",a,"cwFrame")},failureHandler:function(a){CWComManager.tell("failureHandler",a,"cwFrame")},logConsole:function(a,c,b){CWPDFReader.pdfFrameRef?CWPDFReader.pdfFrameRef.CWPDFReader.logConsole(a,c,b):b?(b=CwZ("#CWDailogOverlay"),b.find("#btnCancel").off("click").on("click",function(){CwZ("#CWDailogOverlay").hide()}),c&&b.find("h1").text(c),a&&b.find("p").text(a),"Sign up Successful"!=c&&"Log in Successful"!=
c?CwZ("#CWDailogOverlay").find(".cw-dailog").removeClass("cw-success").addClass("cw-error"):CwZ("#CWDailogOverlay").find(".cw-dailog").addClass("cw-success").removeClass("cw-error"),0==CwZ("#CWDailogOverlay").is(":visible")&&b.show()):CWUtils.log(a)},getData:function(a,c){},getMetaData:function(a,c){try{a.dataUrl?CWParser.getData({metadata:a,success:function(b,e){a.data=Base64.encode(b);c&&c(a,a.index)}}):CWUtils.log("No meta object found"+a)}catch(b){CWDataCenter.postMsgToSentry({view:"mainExt",
message:b.message,stack:b.stack})}},set_bLogin:function(a){CWPDFReader.loginResponse=!0;CWPDFReader.checkLoginInProgress=!1;CWPDFReader.isLogin=a;CWComManager.tell("setLogin",{value:a,view:"pdfFrame"},"pdfFrame")},checkForPDFAccess:function(a){CwZ.ajax({type:"HEAD",url:a,success:function(a,b,d){0<=d.getResponseHeader("Content-Type").indexOf("pdf")?CWDataCenter.findFile(!0):CWDataCenter.findFile(!1)},error:function(a){switch(a.status){case 401:case 403:case 0:CWDataCenter.findFile(!1)}}})},processReferencesFromServer:function(a,
c){var b=[],d={},e;CwZ(a).each(function(a){e=this;d={};d.id=a+1;d.title=e.title&&""!=e.title?e.title:"";a=!1;if(void 0==e.authors||e.authors==[]||""==d.title)e.text?(d.title=e.text,a=!0):e.comments&&0<e.comments.length&&(d.title=e.comments[0],a=!0);a||(e.authors&&(d.author="",CwZ(e.authors).each(function(){d.author+=this.family+" "+this.given.join(" ")+", "})),d.journal=e.source,d.doi=e.doi,d.year=e.date||e.sdate);b.push(d)});CWPDFReader.currentPubReferences=b;CWPDFReader.processReference()},extractReferences:function(a){CWParser.extractReference&&
a.identifier&&""!=a.identifier&&CWComManager.tell("getRefsFromServer",{view:"cwFrame",url:CWPDFReaderConfig.cwURL+"/cites?doi="+a.identifier,metadata:a},"cwFrame")},extractReferenceFromPage:function(a){CWParser.extractReference&&(CWParser.isListingPage()||CWParser.isSearchingPage&&CWParser.isSearchingPage()?ajaxRequest.get({url:a.refLink,type:"GET",success:function(a){a=CwZ(a);CWPDFReader.currentPubReferences=CWParser.getReference(a);CWPDFReader.processReference()},error:function(){CWPDFReader.processReference()}}):
CWParser.isPubPage()&&(CWPDFReader.currentPubReferences=CWParser.getReference(CwZ("body")),CWPDFReader.currentPubReferences&&0==CWPDFReader.currentPubReferences.length?ajaxRequest.get({url:a.refLink,type:"GET",success:function(a){a=CwZ(a);CWPDFReader.currentPubReferences=CWParser.getReference(a);CWPDFReader.processReference()}}):CWPDFReader.processReference()))},processReference:function(){var a=!1;1==CWPDFReader.currentPubReferences.length&&CWPDFReader.currentPubReferences[0].refsNotFound&&(a=!0,
CWPDFReader.currentPubReferences.pop());0!=CWPDFReader.currentPubReferences.length||a||CWDataCenter.postMsgToSentry({view:"mainExt",message:"References Not Extracted",stack:"Could not extract references from page: "+window.location.toString()});CWComManager.tell("recordsOnPage",{records:CWPDFReader.currentPubReferences,view:"pdfFrame"},"pdfFrame")},postBadReference:function(){var a="",c;for(c in CWPDFReader.currentPubReferences){var b=CWPDFReader.currentPubReferences[c];b.bad&&(a+=""==a?b.id:", "+
b.id)}a=a.trim();""!==a&&CWDataCenter.postMsgToSentry({view:"mainExt",message:"Bad References found",stack:"Bad references found on page: "+window.location.toString()+"\r\n Reference number: "+a})},checkBrowser:function(){}},ajaxRequest={get:function(a){var c=new XMLHttpRequest;c.open(a.type,a.url);c.onreadystatechange=function(){4==c.readyState&&(200==c.status?a.success(c.responseText):a.error(c.responseText))};c.send()}};
window.onbeforeunload=function(){var a=!1;CwZ(".cw-btnContainer .cw-addToLib").each(function(){1==CwZ(this).hasClass("cw-ail")&&(a=!0)});if(1==a)return"Are you sure you want to navigate away. All changes will be lost."};
initFunction=function(){try{var a=function(){var b=window.location.href,f="";try{f=atob(window.location.hash.replace("#",""))}catch(g){}-1!=f.indexOf("@@@")&&(b=b.split("#")[0]);if(e!=b){b=window.location.hash;try{b=Base64.decode(b)}catch(k){}if(-1==b.indexOf("@@@")||-1==window.location.hash.indexOf("nbb")||-1==e.indexOf("nbb"))CWPDFReader.init(),CWDataCenter.pubSelected=null;try{c=atob(window.location.hash.replace("#",""))}catch(l){}d=-1!=c.indexOf("@@@");e=window.location.href;d&&(e=e.split("#")[0])}setTimeout(function(){a()},
5E3)};if(!CWUtils.isIframe)if(""==CWPDFReaderConfig.parser)CWUtils.log("NO PARSER LOADED");else{CWPDFReader.initColwizFrame();CWUtils.log("LOADED PARSER : "+CWPDFReaderConfig.parser);window.addEventListener("hashchange",CWPDFReader.onHashChange,!1);var c="";try{c=atob(window.location.hash.replace("#",""))}catch(b){}var d=-1!=c.indexOf("@@@"),e=window.location.href;d&&(e=e.split("#")[0]);a();CWPDFReader.init()}}catch(g){}};initFunction();
