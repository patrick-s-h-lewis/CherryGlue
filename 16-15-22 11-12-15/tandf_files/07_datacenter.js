var _paq=_paq||[],CWApiHandler=CWApiHandler?CWApiHandler:{loadConfig:function(a){CWApiHandler.get(a)},loadComments:function(a){CWApiHandler.get(a)},get:function(a){CWUtils.ajax.get(a.url,a.data,function(c){a.success(c)},function(){a.error()})},post:function(a){CWUtils.ajax.post(a.url,a.data,function(c){a.success(c)},function(c){a.error(c)})},checkLogin:function(a){CwZ.ajax({type:"GET",url:a.url,success:function(c,b,d){a.success(c,b,d)},error:function(c){a.error(c)}})},loadContacts:function(a){CwZ.ajax({type:"GET",
url:a.url,success:function(c,b,d){a.success(c,b,d)},error:function(c){a.error(c)}})},loadGroups:function(a){CwZ.ajax({type:"GET",url:a.url,success:function(c,b,d){a.success(c,b,d)},error:function(c){a.error(c)}})},saveComments:function(a){CWApiHandler.post(a)},findPublication:function(a){CWApiHandler.post(a)},createPublication:function(a){CWApiHandler.post(a)},findFile:function(a){CWApiHandler.post(a)},getUploadParams:function(a){CwZ.ajax({url:a.url,data:a.data,type:"POST",success:function(c){a.success(c)},
error:function(){a.error()}})},findPubs:function(a){CWUtils.ajax.post(a.url,a.data,function(c,b,d){a.success(c,b,d)})},findPubsDOI:function(a){CWApiHandler.get(a)},getFileURL:function(a){CWUtils.ajax.get(a.url,a.data,a.success,a.error)},uploadFile:function(a){try{CWPDFReader.uploadFile(void 0!=a.data.blobLink?a.data.blobLink:a.data.pdfLink,a.data.index,{euId:a.data.euId,fileId:a.data.fileId})}catch(c){CWDataCenter.exceptionHandler(c)}},postToTracker:function(a){},injectPiwik:function(a){},trackPiwik:function(a){},
signoutCallToColwiz:function(a){CwZ.ajax({url:a.url,success:function(c){a.success(c)}})},uploadSync:function(a){CwZ.ajax({url:a.url,data:a.data,type:"POST",success:function(){a.success()}})},getState:function(){},setState:function(){}},CWDataCenter={fileId:null,eId:null,euId:null,pubs:null,blob:null,pubSelected:null,isLogin:!1,isLoginShown:!1,isWorking:!1,isReadOnly:!1,tsCmt:0,bFindPubsChecked:!1,publisherOptions:null,trackerStamp:(new Date).getTime(),trackerID:(1E3*(new Date).getTime()+(Math.floor(200*
Math.random())+100)).toString(16),bRavenConf:!1,myProfileLink:"",loginChecked:!1,etArray:{},lastSyncTS:null,comments:{},piwikConfigured:!1,readerModePiwik:"",isWebImporter:!1,resetVariables:function(){CWDataCenter.fileId=null;CWDataCenter.eId=null;CWDataCenter.euId=null;CWDataCenter.pubSelected=null;CWDataCenter.isReadOnly=!1;CWDataCenter.tsCmt=0;CWDataCenter.trackerStamp=(new Date).getTime();CWDataCenter.trackerID=(1E3*CWDataCenter.trackerStamp+(Math.floor(200*Math.random())+100)).toString(16)},
setPageMeta:function(a){CWDataCenter.pubs=a},signoutCallToColwiz:function(){CWApiHandler.signoutCallToColwiz({url:CWPDFReaderConfig.cwURL+"/?signout",success:function(a){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher&&CWPDFReader.logoutFromReaderCallback();CWUtils.log("signout successful.");CWDataCenter.isLogin=!1;location.reload()}})},redirectToMyProfile:function(){window.open(CWDataCenter.myProfileLink,"_blank")},setMetaData:function(a,c){try{CWDataCenter.pubs[c].data=a.data;var b=a.blobLink||
a.data.blobLink,d=a.blobType||a.data.blobType;b&&(CWDataCenter.pubs[c].blobLink=b,CWDataCenter.pubs[c].blobType=d);CWDataCenter.pubSelected&&CWDataCenter.pubSelected.index===c&&(CWDataCenter.pubSelected.data=a.data)}catch(e){}CWTaskManager.process()},ajaxError:function(a){CWUtils.log("Error");CWUtils.log(a);switch(a.status){case 401:case 403:CWDataCenter.isLogin=!1;CWPDFReaderConfig.isDesktopMode()||CWPDFReader.showLoginFrame();CWPDFReader.hideSyncingDisplay();break;case 0:CWPDFReader.logConsole("It looks like that your internet connection is lost. Kindly check your connection and reload your page.",
"Connection Lost",!0);break;case 503:CWPDFReader.logConsole("Server not found!"),CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||CWPDFReader.showServerDown()}},checkLogin:function(a,c){if(CWDataCenter.loginChecked)CWDataCenter.isLogin?a&&a():c&&c();else{var b=Math.floor((new Date).valueOf()/1E3),b={url:CWPDFReaderConfig.isDesktopMode()?"app/data/user.json":CWPDFReaderConfig.cwURL+"/user?blocking=false&"+b,success:function(b,e,g){CWDataCenter.loginChecked=!0;setTimeout(function(){CWDataCenter.loginChecked=
!1},3E3);CWDataCenter.isWorking=!1;b=parseInt(b);CWUtils.log("data");CWUtils.log(b);if("success"===e&&0!==b){try{CWPDFReaderConfig.uId||CWDataCenter.loadConfig()}catch(f){}CWDataCenter.isLogin=!0;CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||(CWPDFReader.updateUser(CWDataCenter.isLogin),CWPDFReader.set_bLogin&&CWPDFReader.set_bLogin(!0));a&&a()}else CWUtils.log(b),CWUtils.log("not logged in"),CWDataCenter.isLogin=!1,CWPDFReader.set_bLogin&&CWPDFReader.set_bLogin(!1),CWPDFReader.updateUser(CWDataCenter.isLogin),
c&&c()},error:function(a){CWDataCenter.loginChecked=!0;setTimeout(function(){CWDataCenter.loginChecked=!1},3E3);CWDataCenter.isWorking=!1;CWUtils.log("error");CWUtils.log("not logged in");CWDataCenter.isLogin=!1;CWPDFReader.updateUser(CWDataCenter.isLogin);c&&c();CWDataCenter.postMsgToSentry({message:"checklogin failed",stack:a.responseText})}};CWApiHandler.checkLogin(b)}},getCSLFile:function(a){CWUtils.ajax.get(a,{},function(a){CWPDFReader.cslResponse(a)})},getCSLJson:function(a){CWUtils.ajax.get(a,
{},function(a){CWPDFReader.cslJSONResponse(a)})},loadConfig:function(a,c){try{if(!CWDataCenter.isWorking){CWDataCenter.isWorking=!0;var b=(new Date).getTime(),d={url:CWPDFReaderConfig.isDesktopMode()?"app/data/extension.json":CWPDFReaderConfig.cwURL+"/app?x=/pub/extension.json&ts="+b,data:{},success:function(b){CWDataCenter.isWorking=!1;var d={};try{d=CwZ.parseJSON(b);CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher&&CWPDFReader.sendJSONToReader(d);CWDataCenter.proId=d.proId;CWDataCenter.token=
d.token;CWDataCenter.userEmail=d.email;CWDataCenter.myProfileLink=CWPDFReaderConfig.cwURL+"/app?x=/home#app?x=/e101&eId="+d.proId+"&p=1";b=CWPDFReaderConfig;if(0>=d.uId.length)return;CWPDFReaderConfig=d;CWPDFReaderConfig.debug=b.debug;CWPDFReaderConfig.pubModeBtnsTxt=b.pubModeBtnsTxt;CWPDFReaderConfig.extModeBtnsTxt=b.extModeBtnsTxt;CWPDFReaderConfig.readerMode=b.readerMode;CWPDFReaderConfig.cwURL=b.cwURL;CWPDFReaderConfig.parser=b.parser;CWPDFReaderConfig.domain=b.domain;CWPDFReaderConfig.staticDomainURL=
b.staticDomainURL;CWPDFReaderConfig.sentryDomain=b.sentryDomain;CWPDFReaderConfig.piwikSiteId=b.piwikSiteId;CWPDFReaderConfig.isCoreMode=b.isCoreMode;CWPDFReaderConfig.isDesktopMode=b.isDesktopMode;CWPDFReaderConfig.checkReaderMode=b.checkReaderMode;CWPDFReaderConfig.setPublisher=b.setPublisher;CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?CWPDFReaderConfig.checkReaderMode("drive")&&CWDataCenter.loadContacts():(CWPDFReader.updateUser(CWDataCenter.isLogin),("undefined"==typeof c||
c)&&CWPDFReaderConfig.readerMode!=CWPDFReaderMode.Publisher&&CWDataCenter.findPubs());a&&a()}catch(e){CWDataCenter.isLogin=!1,CWDataCenter.exceptionHandler(e)}if(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))d="<div id='cw-pdfReaderConfig' style='display:none;'>"+JSON.stringify(CWPDFReaderConfig)+"</div>",CwZ("#cw-pdfReaderConfig").length?CwZ("#cw-pdfReadeConfig").replaceWith(d):CwZ("body").append(d);else if(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())try{CWPDFReader.loadFile()}catch(k){}CWUtils.log("CWDataCenter.loadConfig DATA LOADED")},
error:function(a){CWDataCenter.ajaxError();CWDataCenter.postMsgToSentry({message:"loadConfig failed",stack:a.responseText})}};CWApiHandler.loadConfig(d)}}catch(e){CWDataCenter.exceptionHandler(e)}},loadContacts:function(){var a={url:CWPDFReaderConfig.cwURL+"/app?x=/search/autocomplete.json&et=101",success:function(a,b,d){CWUtils.log(a);CWDataCenter.etArray["101"]=a;CWUtils.log(b);CWDataCenter.loadGroups()},error:function(a){CWDataCenter.postMsgToSentry({message:"load contacts failed",stack:a.responseText})}};
CwZ.isEmptyObject(CWDataCenter.etArray)&&CWApiHandler.loadContacts(a)},loadGroups:function(){CWApiHandler.loadGroups({url:CWPDFReaderConfig.cwURL+"/app?x=/search/autocomplete.json&et=161",success:function(a,c,b){CWUtils.log(a);CWDataCenter.etArray["161"]=a;CWDataCenter.etArray.proId=CWDataCenter.proId;CWUtils.log(CWDataCenter.etArray);try{CWPDFReader.driveSetUaC(CWDataCenter.etArray)}catch(d){}},error:function(a){CWDataCenter.postMsgToSentry({message:"load groups failed",stack:a.responseText})}})},
syncData:function(){try{(CWPDFReaderConfig.isDesktopMode()||null!=CWDataCenter.fileId)&&CWDataCenter.checkLogin(function(){CWDataCenter.loadComments(function(a,b){if(CWPDFReaderConfig.checkReaderMode("library")||CWPDFReaderConfig.checkReaderMode("librarydesktop"))if(a)CWCommentManager.loadComments(a);else{var d=CWCommentManager.getCommentsString();CWDataCenter.saveComments(d)}else CWPDFReaderConfig.checkReaderMode("drive")?CWCommentManager.loadComments(a,b):CWPDFReader.loadComments(a);setTimeout(CWDataCenter.saveComments,
1E3)},CWPDFReaderConfig.checkReaderMode("drive"))},function(){CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?CWPDFReaderDialog.show({msg:"You are logged out. Kindly sign in to colwiz and retry to continue. ",okBtnTxt:"Retry",cnclBtnTxt:"Close reader",onOk:function(){CWDataCenter.syncData()},onCancel:function(){CWPDFReader.hasPendingChanges(!1);open(location,"_self").close()}}):(CWPDFReader.showLoginFrame(),CWPDFReader.hideSyncingDisplay())})}catch(a){CWDataCenter.exceptionHandler(a)}},
loadComments:function(a,c){CWPDFReaderConfig.isDesktopMode()&&(CWPDFReaderConfig.cmtURL="app/data/comments.json",CWPDFReaderConfig.cmtAllURL="app/data/commentsAll.json");"undefined"==typeof CWPDFReaderConfig.cmtURL&&"undefined"==typeof CWPDFReaderConfig.cmtAllURL||CWApiHandler.loadComments({url:c?CWPDFReaderConfig.cmtAllURL:CWPDFReaderConfig.cmtURL,data:{eId:CWDataCenter.fileId,uId:CWPDFReaderConfig.uId,svc:"cl"},success:function(b){try{if(-1!==b.indexOf("failure"))CWDataCenter.isLogin=!1,CWPDFReaderConfig.dataImgURL=
"",CWPDFReader.updateUser(),CWPDFReader.showLoginFrame();else{var c=CwZ.parseJSON(b),e=null,g=!1,f=0,l=0,k=null,q=!1,n=null,v=function(){if(!CWDataCenter.comments[CWPDFReaderConfig.uId]){var a=CWCommentManager.getDummyData().Colwiz.Comment[0];a.ownerId=n;a.isDummy=!0;CWDataCenter.comments[CWPDFReaderConfig.uId]=a}},r=function(a){u=CwZ.parseJSON(a);w=u.List.MemberData[0].data.Graphics.length;x=u.List.MemberData[0].data.Comments.length;return w+x};if(c.Colwiz&&c.Colwiz.Comment){if(CWPDFReaderConfig.checkReaderMode("library")||
CWPDFReaderConfig.checkReaderMode("librarydesktop"))e=c.Colwiz.Comment[0],e.isCurrentUser=!0,e.commentsString=CWUtils.decompress(e.settings);else if(CWPDFReaderConfig.checkReaderMode("drive")){for(var u,w,x,p=0;p<c.Colwiz.Comment.length;p++){var h=c.Colwiz.Comment[p];h.commentsString=CWUtils.decompress(h.settings);CWDataCenter.comments||(CWDataCenter.comments={});CWDataCenter.comments[h.uId]=h;h.isDummy=!1;!k&&h.uId!==h.ownerId&&h.uId!=CWPDFReaderConfig.uId&&0<r(h.commentsString)&&(k=h.uId);h.uId===
h.ownerId&&(q=h.isOwner=!0,n=h.uId,l=r(h.commentsString),e||(e=h));h.uId===CWPDFReaderConfig.uId&&(g=!0,f=r(h.commentsString),h.isCurrentUser=!0,h.uName="My Annotations",e=h)}g?e=g&&0!==f?CWDataCenter.comments[CWPDFReaderConfig.uId]:q&&0!==l?CWDataCenter.comments[n]:k?CWDataCenter.comments[k]:CWDataCenter.comments[Object.keys(CWDataCenter.comments)[0]]:v();e||(t=CWDataCenter.comments[CWPDFReaderConfig.uId])&&(e=t)}else e=c.Colwiz.Comment[0],e.commentsString=CWUtils.decompress(e.settings),e=e.commentsString;
e&&e.isCurrentUser&&e.mts&&(CWDataCenter.tsCmt=parseInt(e.mts))}else if(CWPDFReaderConfig.checkReaderMode("drive")){v();var t;for(p in CWDataCenter.comments)if(CWDataCenter.comments.hasOwnProperty(p)){h=CWDataCenter.comments[p];h.isDummy&&(t=h);!e&&0<r(h.commentsString)&&(e=h);break}e||(e=t)}else c.Colwiz.Comment&&(e=c.Colwiz.Comment[0],e.commentsString=CWUtils.decompress(e.settings),e=e.commentsString);a&&a(e,CWDataCenter.comments)}}catch(m){c=!1,-1!=m.message.indexOf("Unexpected token <")&&(CWDataCenter.isLogin=
!1,CWPDFReaderConfig.dataImgURL="",CWPDFReader.updateUser(),CWPDFReader.showLoginFrame(),c=!0),CWPDFReaderConfig.checkReaderMode("publisher")?(c&&(m.stack+="\n\n**unexpected token error ** "+b+"\n\n"),PDFRaven.captureException(m)):CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?(c&&(m.stack+="\n\n**unexpected token error ** "+b+"\n\n"),PDFRaven.captureException(m.stack)):PDFRaven.checkDomain()&&CWComManager.postExcToSentry(m),CWUtils.log("loadComments: Comments not Found"),a&&a("")}},
error:function(){CWDataCenter.postMsgToSentry({message:"load comments failed",stack:""});CWDataCenter.ajaxError()}})},saveComments:function(a){if(CWPDFReaderConfig.readerMode!=CWPDFReaderMode.OpenDrive||cPDF.allowMe())try{if(CWPDFReaderConfig.readerMode==CWPDFReaderMode.LibraryDesktop&&(CWDataCenter.fileId={}),CWDataCenter.fileId){if("undefined"===typeof a||""===a||!a)if(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())a=CWCommentManager.getCommentsString();else{CWPDFReader.getComments();
return}if(a){var c;try{0<(a.match(/\n/g)||[]).length&&(a=a.split("\n").join("!^!")),c=CwZ.parseJSON(a)}catch(b){var d=b.message,e;0<d.indexOf("Unexpected token")&&(e=d.split("token ")[1]);a=a.replace(e,"");c=CwZ.parseJSON(a)}var g=!1;c&&(0<c.List.MemberData[0].data.Comments.length||0<c.List.MemberData[0].data.Graphics.length)&&(g=!0);c={};c.id=CWDataCenter.fileId;c.os="16";0<CWDataCenter.tsCmt&&(c.mts=CWDataCenter.tsCmt);c.eus=CWUtils.compress(a);CWPDFReaderConfig.isDesktopMode()&&(c={Colwiz:{Comment:[{settings:CWUtils.compress(a),
mts:CWDataCenter.tsCmt}]}});!g||CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||this.sendOnce||(this.sendOnce=!0);if(CWDataCenter.lastSyncTS!=c.mts||"undefined"==typeof c.mts){var f=CWPDFReaderConfig.isDesktopMode()?"app/data/comments.json":CWPDFReaderConfig.pbxURL;CWApiHandler.saveComments({url:f,data:c,success:function(a){a=CwZ.parseJSON(a);a.success?(CWUtils.log("saveComments response:"+a),g&&CWPDFReader.showProgress("sync-progress","Comments have synced successfully.",0)):CWPDFReaderConfig.isCoreMode()||
CWPDFReaderConfig.isDesktopMode()?(a={msg:"Comments not synced. Please try again or reload the page.",okBtnTxt:"Retry",cnclBtnTxt:"Close reader",onOk:function(){CWDataCenter.syncData()}},CWPDFReaderConfig.isCoreMode()&&CWPDFReaderDialog.show(a)):CWPDFReader.logConsole("Comments not synced. Please try again or reload the page.","Sync failed",!0);CWPDFReader.hideProgress(1500)},error:function(a){CWDataCenter.postMsgToSentry({message:"save comments failed",stack:""});CWDataCenter.ajaxError(a)}})}else CWUtils.log("same mts, save comments successfull"),
g&&CWPDFReader.showProgress("sync-progress","Comments have synced successfully.",0);CWDataCenter.lastSyncTS=c.mts}else CWPDFReader.hideProgress(1)}}catch(l){CWDataCenter.exceptionHandler(l)}else CWPDFReader.hideProgress(100)},addToLibrary:function(a,c){function b(){try{if("109"==parseInt(CWPDFReader.currentPubEId,16).toString().slice(0,3))void 0!=CWPDFReaderConfig.uId?CWDataCenter.addToLibraryThroughPBX():(CWDataCenter.isWorking=!1,CWDataCenter.loadConfig(CWDataCenter.addToLibraryThroughPBX));else if(null==
CWTaskManager.curTask||null!=CWTaskManager.curTask&&a!=CWTaskManager.curTask.data.index){var b=a;void 0==a&&CWDataCenter.pubSelected?b=CWDataCenter.pubSelected:CWPDFReader.pageData&&0<CWPDFReader.pageData.length&&-1==a?b=CWPDFReader.pageData[0]:CWDataCenter.pubs[a]&&(b=CWDataCenter.pubs[a]);if(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))try{CWPDFReader.pubsOnOtherSitesArr[a].addOtherPubs?(b=CWPDFReader.pubsOnOtherSitesArr[a],CWPDFReader.addOtherPub=!1):
CWPDFReader.pubsOnOtherSitesArr[a].addOtherPdfs&&(b=CWPDFReader.pdfsOnOtherSitesArr[a],CWPDFReader.addOtherPdf=!1)}catch(c){}var g=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/;g.test(b.title)||(b.title=Base64.encode(b.title));try{if(void 0!=a&&""!=a&&!CWDataCenter.pubs[a]&&(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox")))for(var f=0;f<CWPDFReader.records.length;f++)CWPDFReader.records[f].index==a&&(b=CWPDFReader.records[f],
g.test(b.title)||(b.title=Base64.encode(b.title)))}catch(l){}if(null!=b&&void 0!=b){var k=new CWTask;k.data=b;k.state=CWTaskState.FindPub;k.bAddToLib=!0;CWTaskManager.addTask(k)}}}catch(q){CWDataCenter.exceptionHandler(q)}}c?b():CWDataCenter.checkLogin(function(){b()},function(){CWPDFReader.showLoginFrame(b);if("109"==parseInt(CWPDFReader.currentPubEId,16).toString().slice(0,3)){var a=CwZ(CwZ("#cw-loginFrame")[0].contentWindow.document.body).find(".cw-login-form #returnURL");a.attr("value",a.attr("value").replace("&success=2",
"&success=3"))}})},addToLibraryThroughPBX:function(){CWDataCenter.findPubForPublicPage(function(){CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:CWPDFReader.currentPubEId,os:5},function(a){CWDataCenter.findFileForPublicPagePDF(JSON.parse(a).success)})})},findPubForPublicPage:function(a){try{CWUtils.ajax.get(CWPDFReaderConfig.cwURL+"/app?x=451&et=109&rsvp=1&eId="+CWPDFReader.currentPubEId,{},function(b,c,e){b=CwZ.parseXML(b);CwZ(b).find("Colwiz Euser settings").length?
(CWDataCenter.pubSelected={id:CWPDFReader.currentPubEId,pdfLink:CWPDFReader.currentPubPdfLink},CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:CWPDFReader.currentPubEId,os:5},function(a){CWDataCenter.findFileForPublicPagePDF(JSON.parse(a).success)}),CWComManager.tell("hasPubInLib",{fileInLib:!0,view:"pdfFrame"})):void 0!=a&&a()})}catch(c){console.log(c)}},findFileForPublicPagePDF:function(a){var c={},b={},d={};c.euId=a.euId;c.create=1;c.fileTitle=CWPDFReader.currentPubPdfLink;
CWUtils.ajax.post(CWPDFReaderConfig.cwURL+"/pub/findfile",c,function(c){var g=null;try{g=CwZ.parseJSON(c)}catch(f){return}200==g.sc?(b.fileId=g.fileId,CWDataCenter.fileId=g.fileId,CWPDFReader.hasPubInLib(!0,b.index),d.state=CWTaskState.Finished,d.bInProcess=!1,CWTaskManager.curTask=d,CWDataCenter.pubSelected=b,CWTaskManager.process(),d.bAddToLib||CWDataCenter.syncData()):201==g.sc?(d.data={},d.data.euId=a.euId,d.data.fileId=g.fileId,d.data.pdfLink=CWPDFReader.currentPubPdfLink,d.data.blobLink=CWPDFReader.currentPubPdfLink,
b.fileId=g.fileId,CWDataCenter.fileId=g.fileId,d.state=CWTaskState.UploadFile,d.bInProcess=!1,CWTaskManager.curTask=d,CWDataCenter.pubSelected=b,CWTaskManager.process()):CWDataCenter.failuresHandler({type:"findfile",e:Error("find file error"),objTask:d})},CWDataCenter.ajaxError)},downloadCitations:function(a){var c=a.data,b=a.type;CWPDFReader.exportCitIdx=0;var d=!1,e=function(){var a=c[CWPDFReader.exportCitIdx],a=parseInt(a),f=-1==a?CWPDFReader.pageData[0]:CWPDFReader.records[a];CWParser.name&&CWParser.isPubPage()&&
(f=CWPDFReader.records[0]);var l=f.type==b;if("webpage"==f.redif_type&&0==CWPDFReader.records.length){if("bib"==f.type||"ris"==f.type)/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/.test(f.data)&&(f.data=Base64.decode(f.data)),a=f.data,l||(a=citConverterMain(a,b,f)),CWPDFReader.exportCit[b].push(a);++CWPDFReader.exportCitIdx==c.length?(CWDataCenter.saveAndReset(),setTimeout(function(){CWPDFReader.processingDownloadCit=!1;CWPDFReader.exportInProgress=!0},
2E3)):e()}else f.data="",Utility.getData({metadata:f,success:function(a,g){f.data=a;f.type=g;if("bib"==f.type||"ris"==f.type){/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/.test(f.data)&&(f.data=Base64.decode(f.data));var n=f.data;l||(n=citConverterMain(n,b,f));CWPDFReader.exportCit[b].push(n)}else d=!0;++CWPDFReader.exportCitIdx==c.length?(CWDataCenter.saveAndReset(),setTimeout(function(){CWPDFReader.processingDownloadCit=!1;CWPDFReader.exportInProgress=
!0;d&&CWlogger.logConsole("Extension doesn't support '"+f.type+"' publication type for export citation.","Publication type not supported!",!0)},2E3)):e()},error:function(){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&(CWComManager.exportedCitation="failed")}})};e()},saveAndReset:function(){var a=["bib","ris"];CwZ(a).each(function(c){c=a[c];var b=CWPDFReader.exportCit[c];if(b.length){var b=b.join("\n\n"),d=new Blob([b],{type:"text/plain;charset=utf-8"});CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&
(CWComManager.exportedCitation=b);saveAs(d,"ExportCitation."+c)}});CWPDFReader.exportCit={bib:[],ris:[]}},downloadPDF:function(a){saveAs(a.blob,a.name)},getFileId:function(a){var c=CWDataCenter.pubSelected;if(null!=c){var b=new CWTask;b.data=c;b.state=CWTaskState.FindPub;b.bAddToLib=!1;a&&(b.bAddToLib=!0);CWTaskManager.checkedLogin=!0;CWTaskManager.addTask(b)}},getPostData:function(a,c){void 0==c&&(c=!1);try{var b={authors:a.authors?a.authors:"",dataUrl:a.dataUrl?a.dataUrl:"",identifier:a.identifier?
a.identifier:"",identifierType:a.identifierType?a.identifierType:"",index:0,psp:0,pdfLink:a.pdfLink?a.pdfLink:"",pubLink:a.pubLink?a.pubLink:"",title:a.title?a.title:"",type:a.type?a.type:"",domain:"webpdf",ts:(new Date).getTime()};void 0!=a.journal&&(b.journal=a.journal);void 0!=a.year&&(b.year=a.year);void 0!=a.openaccess&&(b.openaccess=a.openaccess);void 0!=a.listingPage&&(b.listingPage=a.listingPage);void 0!=a.title&&(b.title=a.title);void 0!=a.authors&&(b.authors=a.authors);void 0!=a.issn&&(b.issn=
a.issn);c&&(b.data=a.data);CWDataCenter.publisherOptions&&(b.appId=CWDataCenter.publisherOptions.appId,"0000-0000"!=CWDataCenter.publisherOptions.issn&&(b.issn=CWDataCenter.publisherOptions.issn));return b}catch(d){CWDataCenter.exceptionHandler(d)}},failuresHandler:function(a){var c={logout:{heading:"Logged out",msg:"You are logged out. Kindly sign in to colwiz and retry to continue. ",buttons:{ok:"Retry",cancel:"Abort"},func:function(a){c.finishTask(a)}},createPub:{heading:"Adding Publication Failed",
msg:"An error occurred while creating publication. Please retry after a few seconds. ",func:function(a){c.finishTask(a)}},addingPDF:{heading:"Adding PDF Failed",msg:"An error occurred while adding PDF . The publication has been added in your library though. Please retry after a few seconds. ",func:function(a){c.finishTask(a)}},finishTask:function(a){var b=null;if(a.objTask)b=a.objTask;else if(a.index){a=a.index;var c=CWTaskManager.curTask,f=CWTaskManager.arrTasks;if(c&&c.data.index==a)b=c;else if(0<
f.length)for(c=0;c<f.length;c++){var l=f[c];l.data.index==a&&(b=l)}}b&&(a=b.data,CWDataCenter.isLogin=!1,CWPDFReader.showProgress("userLoggedOut","User Logged Out",0,a.index),CWPDFReaderConfig.dataImgURL="",CWPDFReader.updateUser(),b.bInProcess=!1,b.state=CWTaskState.Finished,CWTaskManager.process())}},b;switch(a.type){case "logout":b=c.logout;break;case "createpub":b=c.createPub;break;case "addingPDF":b=c.addingPDF;break;case "uploadfile":b=c.addingPDF}(function(a,b){try{CWPDFReaderConfig.isCoreMode()||
CWPDFReaderConfig.isDesktopMode()?CWPDFReaderDialog.show({msg:a.msg?a.msg:b.msg,okBtnTxt:a.okBtnTxt?a.okBtnTxt:b.buttons.ok,cnclBtnTxt:a.cnclBtnTxt?a.cnclBtnTxt:b.buttons.cancel,onOk:a.succFunc?a.succFunc:void 0,onCancel:a.errFunc?a.errFunc:void 0}):CWPDFReader.logConsole(b.msg,b.heading,!0),b.func&&b.func(a)}catch(c){}})(a,b)},exceptionHandler:function(a){CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?PDFRaven.captureException(a.stack):CWPDFReaderConfig.checkReaderMode("publisher")?
PDFRaven.captureException(a):PDFRaven.checkDomain()&&CWComManager.postExcToSentry(a)},findPublication:function(a){function c(b){var c=CWDataCenter.getPostData(b);c.idType=b.identifierType;c.id=b.identifier;c.url=b.pubLink;CWApiHandler.findPublication({url:CWPDFReaderConfig.cwURL+"/pub/findpub",data:c,success:function(c){var d=null;try{d=CwZ.parseJSON(c)}catch(f){CWDataCenter.failuresHandler({type:"logout",e:f,objTask:a});return}200==d.sc?(b.eId=d.eId,CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||
CWPDFReader.setPublicationId(b.eId),d.euId?(b.euId=d.euId,a.state=CWTaskState.FindFile):a.state=a.bAddToLib?CWTaskState.CreatePub:CWTaskState.Finished):404==d.sc&&(a.bAddToLib?a.state=CWTaskState.CreatePub:(CWPDFReader.hideProgress(1),a.state=CWTaskState.Finished));a.bInProcess=!1;CWTaskManager.process()},error:function(a){CWDataCenter.ajaxError(a);CWDataCenter.postMsgToSentry({message:"findPub failed",stack:a.responseText})}})}CWDataCenter.checkLogin(function(){a.bAddToLib&&CWPDFReader.showProgress("addPub",
"Adding...",0,a.data.index);var b=a.data;if(b)try{c(b)}catch(d){CWDataCenter.exceptionHandler(d)}},function(){})},createPublication:function(a){try{var c=a.data,b=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/;if(c&&0!=c.data.length){b.test(c.data)||(c.data=Base64.encode(c.data));b.test(c.title)||(c.title=btoa(c.title));var d=CWDataCenter.getPostData(c,!0);null!=c.eId&&(d.eId=c.eId);var e="["+JSON.stringify(d)+"]";d.data=e;CWApiHandler.createPublication({url:CWPDFReaderConfig.cwURL+
"/pub/createpub",data:d,success:function(b){if(""==b)CWDataCenter.failuresHandler({type:"logout",e:e,objTask:a});else{e=null;try{e=CwZ.parseJSON(b)}catch(d){CWDataCenter.failuresHandler({type:"logout",e:d,objTask:a});return}c.title=atob(c.title);if(200==e.sc)c.euId=e.euId,CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&CWComManager.addedEids.push(e.eId),a.state=CWTaskState.FindFile,CWPDFReader.showProgress("addPub","Adding...",50,a.data.index),a.bInProcess=!1,CWTaskManager.process();else{var e=
Error("create pub error");CWDataCenter.failuresHandler({type:"createpub",e:e,objTask:a})}}},error:function(a){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&CWComManager.addedEids.push("failed");CWDataCenter.ajaxError(a);CWDataCenter.postMsgToSentry({message:"createPub failed",stack:a.responseText})}})}else a.bInProcess=!1,(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))&&CWParser?(b.test(c.title)&&(c.title=atob(c.title)),CWParser.getData({metadata:c,
success:function(a,b){c.data=a;c.data=Base64.encode(c.data);c.type=b;CWDataCenter.setMetaData(c,c.index)}})):CWPDFReaderConfig.checkReaderMode("publisher")&&CWPDFReader.getMetaData(c)}catch(g){CWDataCenter.exceptionHandler(g)}},findFile:function(a,c){try{var b=a.data,d=CWUtils.getFileTitle(b),e=CWDataCenter.getPostData(b);if(1==a.bAddToLib){e.create=1;if(void 0==c&&b.pdfLink&&""!=b.pdfLink){CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox")?CWPDFReader.checkForPDFAccess(b.blobType):
CWPDFReader.checkForPDFAccess(b.pdfLink);return}if(c)e.create=1;else{CWPDFReader.hasPubInLib(!0,b.index);a.state=CWTaskState.Finished;a.bInProcess=!1;CWTaskManager.process();return}}e.euId=b.euId;e.fileTitle=d;e.ts=(new Date).getTime();CWDataCenter.publisherOptions&&(e.appId=CWDataCenter.publisherOptions.appId,e.issn="0000-0000"!=CWDataCenter.publisherOptions.issn?CWDataCenter.publisherOptions.issn:void 0!=b.issn?b.issn:"");void 0!=b.journal&&(e.journal=b.journal);void 0!=b.year&&(e.year=b.year);
void 0!=b.openaccess&&(e.openaccess=b.openaccess);void 0!=b.listingPage&&(e.listingPage=b.listingPage);CWApiHandler.findFile({url:CWPDFReaderConfig.cwURL+"/pub/findfile",data:e,success:function(c){var d=null;try{d=CwZ.parseJSON(c)}catch(e){CWDataCenter.failuresHandler({type:"logout",e:e,objTask:a});return}200==d.sc?(b.fileId=d.fileId,CWDataCenter.fileId=d.fileId,CWPDFReader.hasPubInLib(!0,b.index),a.state=CWTaskState.Finished,a.bInProcess=!1,CWTaskManager.process(),CWDataCenter.syncData()):201==d.sc?
(b.fileId=d.fileId,CWDataCenter.fileId=d.fileId,a.state=CWTaskState.UploadFile,a.bInProcess=!1,CWTaskManager.process()):(CWDataCenter.fileId=d.fileId,CWPDFReader.hasPubInLib(!0,b.index),a.state=CWTaskState.Finished,a.bInProcess=!1,CWTaskManager.process(),CWDataCenter.failuresHandler({type:"findfile",e:Error("find file error"),objTask:a}))},error:function(a){CWDataCenter.ajaxError(a);CWDataCenter.postMsgToSentry({message:"findFile failed",stack:a.responseText})}})}catch(g){CWDataCenter.exceptionHandler(g)}},
uploadFile:function(a){try{var c={euId:a.data.euId,fileId:a.data.fileId};CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher?CWPDFReader.uploadFile(a.data.pdfLink,a.data.index,c):CWPDFReader.uploadFile(a.data.blobLink,a.data.index,c)}catch(b){CWDataCenter.exceptionHandler(b)}},getUploadParams:function(a){CWUtils.log(CWPDFReaderConfig.cwcURL);try{CWApiHandler.getUploadParams({url:CWPDFReaderConfig.cwcURL,data:a,success:function(b){var c,e={};if(b.success)c=b.success;else if(b.failure&&"logged out."==
b.failure.msg){CWDataCenter.failuresHandler({type:"logout",e:Error("Logged out")});return}c&&(CWTaskManager.curTask.data.fileId=c.eId,e.key=c.key,e.acl=c.acl,e.AWSAccessKeyId=c.AWSAccessKeyId,e.policy=c.policy,e.signature=c.signature,e.Filename=a.title,CWDataCenter.setKeyValue("x-amz-server-side-encryption",c,e),CWDataCenter.setKeyValue("x-amz-meta-uuid",c,e),CWDataCenter.setKeyValue("x-amz-storage-class",c,e),CWDataCenter.setKeyValue("Content-Disposition",c,e),CWDataCenter.setKeyValue("Content-Type",
c,e),CWPDFReader.postFile(e,c.postURL))},error:function(a){CWUtils.log("Either you don't have rights to post or your uploaded quota is finished. ");CWDataCenter.postMsgToSentry({message:"getUploadParams failed",stack:a.responseText})}})}catch(c){CWDataCenter.exceptionHandler(c)}},setKeyValue:function(a,c,b){(c=c[a])&&(b[a]=c)},uploadSync:function(a){void 0===a.doSync&&(a.doSync=!1);try{CWApiHandler.uploadSync({url:CWPDFReaderConfig.cwcURL,data:a,success:function(){CWUtils.log("UPLOAD SYNC:"+a.sync);
2==a.sync&&(CWPDFReader.hasPubInLib(!0,a.index),CWTaskManager.curTask.state=CWTaskState.Finished,CWTaskManager.curTask.bInProcess=!1,CWTaskManager.process(),a.doSync&&CWDataCenter.syncData())},error:function(a){CWDataCenter.postMsgToSentry({message:"uploadSync failed",stack:a.responseText})}})}catch(c){CWDataCenter.exceptionHandler(c)}},getFileURL:function(a,c,b,d){try{var e=CWPDFReaderConfig.cwcURL.replace("&et=28","&et="+c);a={eId:a,geturl:1};b&&(a.preview=!0);CWApiHandler.getFileURL({url:e,data:a,
success:d,error:CWDataCenter.ajaxError})}catch(g){CWDataCenter.exceptionHandler(g)}},polling:function(){CWDataCenter.loadConfig(function(){})},updateUserDOM:function(){CWPDFReader.updateUser()},postMsgToSentry:function(a){CWUtils.log("in final sentry tracking func: "+a.message);var c=Error(a.message);c.stack=a.stack;CWUtils.log(c);try{PDFRaven.captureException(c)}catch(b){}},setImporter:function(){CWDataCenter.isWebImporter=!0},postToTracker:function(a,c){var b,d=c||CWDataCenter.pubSelected;if(CWDataCenter.isWebImporter||
CWPDFReaderConfig.checkReaderMode("chrome")&&null==d&&("openpopup"==a||"p-gotolibrary"==a||"searchKeyword"==a.action))d="undefined"!=typeof CWPDFReader.pageData&&0<CWPDFReader.pageData.length?CWPDFReader.pageData[0]:CWDataCenter.pubs[0];if(null!=d){var e=[];if("events"===a){try{e=d.match(/"(.*?)"/g)}catch(g){}b={};b.events=d;CWDataCenter.pubSelected&&void 0!==CWDataCenter.pubSelected.issn&&(b.issn=CWDataCenter.pubSelected.issn);CWDataCenter.publisherOptions&&(b.appId=CWDataCenter.publisherOptions.appId);
"undefined"===typeof b.appId&&(b.appId="undefined"!=typeof CWParser?"undefined"!=typeof CWParser.name?CWParser.name+"_extension":"webpageReference_extension":"webpageReference_extension")}else b=CWDataCenter.getPostData(d),"undefined"==typeof b.appId&&(b.appId="undefined"!=typeof CWParser?"undefined"!=typeof CWParser.name?CWParser.name+"_extension":"webpageReference_extension":"webpageReference_extension"),b.idType=d.identifierType,b.id=d.identifier,b.url=d.pubLink,delete b.title,delete b.data,delete b.authors,
delete b.dataUrl,delete b.identifierType,delete b.index,delete b.psp,delete b.pdfLink,delete b.pubLink,delete b.type,delete b.domain,delete b.idType,delete b.domain;b.lts=this.trackerStamp;b.tId=this.trackerID;this.trackerStamp=(new Date).getTime();b.uId=CWPDFReaderConfig.uId||CWUtils.readCookie("_ut");b.uId||(d=1E4*b.ts+(Math.floor(2E3*Math.random())+1E3),b.uId="u"+d.toString(16),CWPDFReaderConfig.checkReaderMode("chrome")&&(-1==CWPDFReader.postDataUId&&(CWPDFReader.postDataUId=b.uId),b.uId=CWPDFReader.postDataUId),
CWUtils.writeCookie("_ut",b.uId,365));"searchKeyword"==a.action?(b.action=a.action,b.searchQuery=a.key):b.action=a;if("https://www.colwiz.com"==CWPDFReaderConfig.cwURL||"https://qa.colwiz.com"==CWPDFReaderConfig.cwURL)switch(0==CWDataCenter.piwikConfigured&&(CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome?CWDataCenter.readerModePiwik="Chrome":CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter||CWDataCenter.isWebImporter?CWDataCenter.readerModePiwik="WebImporter":CWPDFReaderConfig.readerMode==
CWPDFReaderMode.Publisher?(CWDataCenter.readerModePiwik="Reader","undefined"!==typeof isCwZExtension&&(CWDataCenter.readerModePiwik="Chrome")):CWPDFReaderConfig.readerMode==CWPDFReaderMode.Library?CWDataCenter.readerModePiwik="Library":CWPDFReaderConfig.readerMode==CWPDFReaderMode.Drive&&(CWDataCenter.readerModePiwik="Drive"),CWDataCenter.piwikConfigured=!0,CWDataCenter.injectPiwik(b)),a){case "events":try{for(d=0;d<e.length;d++)e[d]=e[d].replace(RegExp('"',"g"),""),CWDataCenter.trackPiwik(e[d],b)}catch(f){}break;
default:"undefined"!==typeof a.action?CWDataCenter.trackPiwik(a.action,b):CWDataCenter.trackPiwik(a,b)}}},injectPiwik:function(a){if(CWPDFReaderConfig.piwikSiteId)if(CWPDFReaderConfig.piwikSiteId="https://www.colwiz.com"==CWPDFReaderConfig.cwURL?2:5,CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome)try{if("undefined"!=typeof CwZ("#piwikFrame")[0]){var c=CwZ("#piwikFrame")[0].contentWindow.document,b=c.createElement("script"),c=c.getElementsByTagName("script")[0];b.type="text/javascript";b.defer=
!0;b.async=!0;b.src="https://reports.colwiz.com/piwik/piwik.js";if("undefined"!=typeof c){c.parentNode.insertBefore(b,c);var d={message:"initPiwik",piwikSiteId:CWPDFReaderConfig.piwikSiteId};"undefined"!==typeof a&&(d.appId=a.appId,d.issn=null===a.issn?"notfound":a.issn,d.journal=null===a.journal?"notfound":a.journal);CwZ("#piwikFrame")[0].contentWindow.postMessage(d,"*")}else setTimeout(function(){CWDataCenter.injectPiwik()},1E3)}else setTimeout(function(){CWDataCenter.injectPiwik()},1E3)}catch(e){CWUtils.log(e)}else(function(){_paq.push(["setTrackerUrl",
"https://reports.colwiz.com/piwik/piwik.php"]);_paq.push(["setSiteId",CWPDFReaderConfig.piwikSiteId]);var a=document,b=a.createElement("script"),a=a.getElementsByTagName("script")[0];b.type="text/javascript";b.defer=!0;b.async=!0;b.src="https://reports.colwiz.com/piwik/piwik.js";a.parentNode.insertBefore(b,a)})(),_paq.push(["enableLinkTracking"]),_paq.push(["setCustomVariable",5,"ReaderMode",CWDataCenter.propName(CWPDFReaderMode,CWPDFReaderConfig.readerMode),"visit"]),"undefined"!==typeof a&&(_paq.push(["setCustomVariable",
4,"AppID",a.appId,"visit"]),_paq.push(["setCustomVariable",3,"ISSN",null===a.issn?"notfound":a.issn,"visit"]),_paq.push(["setCustomVariable",2,"Journal",null===a.journal?"notfound":a.journal,"visit"])),"undefined"!==typeof CWPDFReaderConfig.uId&&_paq.push(["setUserId",CWPDFReaderConfig.uId]),_paq.push(["trackPageView"])},trackPiwik:function(a,c){if(CWPDFReaderConfig.piwikSiteId)if(CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome)try{"clickpdf"==a?setTimeout(function(){CwZ("#piwikFrame")[0].contentWindow.postMessage({message:"trackPiwik",
action:a,readerModePiwik:CWDataCenter.readerModePiwik,piwikSiteId:CWPDFReaderConfig.piwikSiteId},"*")},1E3):CwZ("#piwikFrame")[0].contentWindow.postMessage({message:"trackPiwik",action:a,readerModePiwik:CWDataCenter.readerModePiwik,piwikSiteId:CWPDFReaderConfig.piwikSiteId},"*")}catch(b){}else _paq.push(["setCustomVariable",5,"ReaderMode",CWDataCenter.propName(CWPDFReaderMode,CWPDFReaderConfig.readerMode),"visit"]),"undefined"!==typeof c&&(_paq.push(["setCustomVariable",4,"AppID",c.appId,"visit"]),
_paq.push(["setCustomVariable",3,"ISSN",null===c.issn?"notfound":c.issn,"visit"]),_paq.push(["setCustomVariable",2,"Journal",null===c.journal?"notfound":c.journal,"visit"])),"undefined"!==typeof CWPDFReaderConfig.uId&&_paq.push(["setUserId",CWPDFReaderConfig.uId]),_paq.push(["trackEvent",CWDataCenter.readerModePiwik,a])},propName:function(a,c){for(var b in a)if(a[b]==c)return b;return c},findPubs:function(){if(CWPDFReaderConfig.readerMode!=CWPDFReaderMode.Webimporter){var a=[];if(CWDataCenter.pubs)for(var c in CWDataCenter.pubs){var b=
CWDataCenter.pubs[c],b={type:b.identifierType,value:b.identifier,url:b.pubLink,pdfLink:b.pdfLink};a.push(b)}else for(c in CWPDFReader.pageData)b=CWPDFReader.pageData[c],b={type:b.identifierType,value:b.identifier,url:b.pubLink,pdfLink:b.pdfLink},a.push(b);a=JSON.stringify(a);b={};b.ids='{"ids":'+a+"}";try{CWApiHandler.findPubs({url:CWPDFReaderConfig.cwURL+"/pub/findpubs",data:b,success:function(a,b,c){b=null;try{if(-1==(c.getResponseHeader("content-type")||"").indexOf("html")&&-1==a.indexOf('{"failure":')&&
(b=CwZ.parseJSON(a),CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&(CWComManager.findPubs=b),CWUtils.log("findPubs response:  "+a),b.ids))for(a=0;a<b.ids.length;a++)if(b.ids[a].euId)CWPDFReader.hasPubInLib(!0,a);else if(!CWPDFReaderConfig.isCoreMode()&&!CWPDFReaderConfig.isDesktopMode()){var d=CwZ(".cw-btnContainer:eq("+a+") .cw-addToLib");d.hasClass("cw-vil")&&(d.removeClass("cw-vil"),d.removeClass("cw-ail"),d.removeClass("cw-qta"),d.addClass("cw-atl"),d.find("span").html("Add to colwiz Library"),
d.find("em").html("Save article PDF and metadata to your colwiz Library. Access anywhere, cite them and generate bibliographies."))}}catch(k){CWUtils.log("FIND PUB ERROR"),CWDataCenter.exceptionHandler(k)}},error:function(a){CWDataCenter.postMsgToSentry({message:"findPubs failed",stack:a.responseText})}})}catch(d){CWDataCenter.exceptionHandler(d)}}},PubsDoiUrlHash:{},findPubsDOI:function(){if(CWDataCenter.isLogin&&!CWDataCenter.bFindPubsChecked&&(!CWDataCenter.publisherOptions||CWDataCenter.publisherOptions.showAddToColwiz)){for(var a=
"",c=0;c<CWPDFReader.records.length;c++){var b=CWDataCenter.pubs[c];"doi"==b.identifierType&&(CWDataCenter.PubsDoiUrlHash[b.identifier]=c,a=""===a?a+("doi="+b.identifier):a+("&doi="+b.identifier))}try{CWUtils.ajax.get(CWPDFReaderConfig.cwURL+"/pub/findpubsbydoi?"+a,{},function(a){var b=null;try{for(b=CwZ.parseJSON(a).response,CWUtils.log("findpubsbydoi response:  "+a),a=0;a<b.docs.length;a++){var c=b.docs[a];c.doi&&CWPDFReader.hasPubInLib(!0,CWDataCenter.PubsDoiUrlHash[c.doi])}}catch(d){CWDataCenter.exceptionHandler(d)}})}catch(d){CWDataCenter.exceptionHandler(d)}CWDataCenter.bFindPubsChecked=
!0}},checkPendingTasks:function(){(null!=CWTaskManager.curTask||0<CWTaskManager.arrTasks.length)&&CWDataCenter.isLogin?CWPDFReader.setPendingTasks(!0):CWPDFReader.setPendingTasks(!1)},removeAllTasks:function(){CWTaskManager.removeAllTasks()},getRelatedPubs:function(a){try{CwZ.get(a).success(function(a){CWPDFReader.setRelatedPubs(a)})}catch(c){}},getRefsFromServer:function(a,c){try{CwZ.get(a).success(function(a){CWPDFReader.serverRefsResponse(a,c)}).error(function(){CWPDFReader.serverRefsResponse(0,
c)})}catch(b){}},addRelatedPub:function(a){try{CWPDFReaderConfig.pbxURL?CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:a,os:5},function(b){CWPDFReader.addRelatedPubResp({eId:a,resp:b})}):CWDataCenter.loadConfig(function(){CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:a,os:5},function(b){CWPDFReader.addRelatedPubResp({eId:a,resp:b})})})}catch(c){}},ajaxCall:function(a){try{CwZ.ajax({url:a.url,type:a.type,data:a.params,
success:function(b){a.response=b;CWPDFReader.ajaxCallResp(a)},error:function(){CWPDFReader.ajaxCallResp(a)}})}catch(c){CWPDFReader.ajaxCallResp(a)}},getAuthors:function(a,c,b){b?(c=c.data.replace('["',"").replace('"]',""),a+=":"+encodeURIComponent(c),CwZ.ajax({type:"GET",url:a,success:function(a,b,c){CWPDFReader.sendAuthors(a)},error:function(a){}})):CwZ.ajax({type:"POST",url:a,data:c,success:function(a,b,c){CWPDFReader.sendAuthors(a)},error:function(a){}})}},PDFRaven={domain:CWPDFReaderConfig.cwURL,
captureException:function(a){},captureMessage:function(a){},set:function(){TraceKit.domain=PDFRaven.domain;TraceKit.checkDomain=PDFRaven.checkDomain;PDFRaven=TraceKit},checkDomain:function(){return-1!=PDFRaven.domain.indexOf(CWPDFReaderConfig.sentryDomain)}};(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())&&CWDataCenter.checkLogin(CWDataCenter.loadConfig);-1!=CWPDFReaderConfig.cwURL.indexOf(CWPDFReaderConfig.sentryDomain)&&(CWUtils.log("PDFRaven is set for this reader"),PDFRaven.set());
var CWTaskManager={arrTasks:[],curTask:null,checkedLogin:!1,addTask:function(a){try{0<CWTaskManager.arrTasks.length&&a.bAddToLib&&CWPDFReader.showProgress("queue","Queued to Add",0,a.data.index),CWTaskManager.arrTasks.push(a),CWTaskManager.process()}catch(c){CWDataCenter.exceptionHandler(c)}},removeTask:function(a){for(var c=0;c<CWTaskManager.arrTasks.length;c++)if(CWTaskManager.arrTasks[c].id==a)return CWTaskManager.arrTasks.splice(c,1)},removeAllTasks:function(){CWTaskManager.arrTasks=[];CWTaskManager.curTask=
null;CWTaskManager.checkedLogin=!1},process:function(){try{if(0<CWTaskManager.arrTasks.length&&null==CWTaskManager.curTask&&(CWTaskManager.curTask=CWTaskManager.arrTasks.shift()),CWTaskManager.curTask&&!CWTaskManager.curTask.bInProcess){var a=CWTaskManager.curTask;a.bInProcess=!0;switch(a.state){case CWTaskState.FindPub:CWDataCenter.findPublication(a);break;case CWTaskState.CreatePub:CWDataCenter.createPublication(a);break;case CWTaskState.FindFile:CWDataCenter.findFile(a);break;case CWTaskState.UploadFile:CWDataCenter.uploadFile(a);
break;default:a.bInProcess=!1,CWTaskManager.curTask=null,setTimeout(CWTaskManager.process,100),CWDataCenter.checkPendingTasks&&CWDataCenter.checkPendingTasks()}}}catch(c){CWDataCenter.exceptionHandler(c)}}};function CWTask(){this.id="T"+(new Date).getTime();this.state=CWTaskState.FindPub;this.data=null;this.progress=0;this.bInProcess=this.bAddToLib=!1}var CWTaskState={FindPub:"findPub",CreatePub:"createPub",FindFile:"findFile",UploadFile:"uploadFile",Finished:"finished"};
